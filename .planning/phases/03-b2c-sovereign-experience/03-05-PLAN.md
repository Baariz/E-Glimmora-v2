---
phase: 03-b2c-sovereign-experience
plan: 05
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - src/app/(b2c)/messages/page.tsx
  - src/app/(b2c)/messages/[threadId]/page.tsx
  - src/components/b2c/messaging/ThreadList.tsx
  - src/components/b2c/messaging/ThreadView.tsx
  - src/components/b2c/messaging/MessageBubble.tsx
  - src/components/b2c/messaging/MessageInput.tsx
  - src/components/b2c/messaging/NewThreadModal.tsx
  - src/app/(b2c)/intelligence/page.tsx
  - src/components/b2c/intelligence/EmotionalTrends.tsx
  - src/components/b2c/intelligence/LifestylePatterns.tsx
  - src/components/b2c/intelligence/RenewalSignals.tsx
  - src/components/b2c/intelligence/ExposureRiskOverview.tsx
autonomous: true

must_haves:
  truths:
    - "UHNI can initiate secure messaging thread per journey and see full message history"
    - "System state messages appear automatically for journey state changes"
    - "UHNI can view Intelligence Brief with emotional trends, lifestyle patterns, renewal signals, and exposure risk"
    - "Intelligence Brief has magazine-style editorial layout"
  artifacts:
    - path: "src/app/(b2c)/messages/page.tsx"
      provides: "Messaging thread list page"
      min_lines: 30
    - path: "src/components/b2c/messaging/ThreadView.tsx"
      provides: "Thread view with message history and input"
      min_lines: 50
    - path: "src/app/(b2c)/intelligence/page.tsx"
      provides: "Intelligence Brief magazine layout"
      min_lines: 60
    - path: "src/components/b2c/intelligence/EmotionalTrends.tsx"
      provides: "Emotional trend visualization"
      min_lines: 40
  key_links:
    - from: "src/components/b2c/messaging/ThreadView.tsx"
      to: "src/lib/services/mock/message.mock.ts"
      via: "getMessages / sendMessage"
      pattern: "getMessages|sendMessage"
    - from: "src/components/b2c/messaging/NewThreadModal.tsx"
      to: "src/lib/services/mock/message.mock.ts"
      via: "createThread linked to journey"
      pattern: "createThread.*relatedResourceId"
    - from: "src/components/b2c/intelligence/EmotionalTrends.tsx"
      to: "recharts"
      via: "LineChart for trend visualization"
      pattern: "LineChart|AreaChart|recharts"
    - from: "src/components/b2c/journeys/ConfirmJourneyFlow.tsx"
      to: "src/lib/services/mock/message.mock.ts"
      via: "system message creation on journey state change"
      pattern: "sendMessage.*system|createSystemMessage"
---

<objective>
Build Advisor Collaboration messaging (journey-based threads with full history) and the Intelligence Brief (magazine-style analytical view with emotional trends, lifestyle patterns, renewal signals, and exposure risk).

Purpose: Messaging enables UHNI-advisor collaboration on specific journeys. The Intelligence Brief provides a sophisticated analytical view of the UHNI's emotional and lifestyle patterns. Both must feel editorial and luxurious.
Output: Working /messages page with thread list and thread view, /intelligence page with 4 analytical sections in magazine layout.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-b2c-sovereign-experience/03-RESEARCH.md
@.planning/phases/03-b2c-sovereign-experience/03-01-SUMMARY.md
@.planning/phases/03-b2c-sovereign-experience/03-03-SUMMARY.md

@src/lib/types/entities.ts
@src/lib/services/mock/message.mock.ts
@src/lib/services/interfaces/IMessageService.ts
@src/app/(b2c)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build journey-based messaging with threads, history, and system messages</name>
  <files>
    src/app/(b2c)/messages/page.tsx
    src/app/(b2c)/messages/[threadId]/page.tsx
    src/components/b2c/messaging/ThreadList.tsx
    src/components/b2c/messaging/ThreadView.tsx
    src/components/b2c/messaging/MessageBubble.tsx
    src/components/b2c/messaging/MessageInput.tsx
    src/components/b2c/messaging/NewThreadModal.tsx
  </files>
  <action>
    1. **ThreadList.tsx**: List of messaging threads:
       - Fetches threads from message service for current user
       - Each thread shows: linked journey title (fetch from journey service using relatedResourceId), last message preview, timestamp, participant names
       - Unread indicator if messages exist that user hasn't read
       - Click navigates to /messages/[threadId]
       - Loading skeleton while fetching
       - Sort by lastMessageAt descending (most recent first)

    2. **MessageBubble.tsx**: Individual message display:
       - Two styles: own messages (aligned right, rose background) vs other messages (aligned left, sand background)
       - System messages (COLB-04): centered, italic, sand-400 text, no bubble (e.g., "Journey status changed to Approved")
       - Show sender name (for non-own messages), timestamp, content
       - Framer Motion entrance animation (slide up with opacity)

    3. **MessageInput.tsx**: Message composition:
       - Text input with send button
       - Shift+Enter for newline, Enter to send
       - Disable when empty
       - Loading state while sending
       - Optimistic updates (per research pitfall #4): add message to UI immediately with pending state, reconcile on server response

    4. **ThreadView.tsx** (COLB-01, COLB-03): Full thread view:
       - Header: linked journey title, participant names, "Back to threads" link
       - Scrollable message list (auto-scroll to bottom on new messages)
       - MessageInput at bottom (fixed position)
       - Fetches all messages for thread
       - Marks messages as read on view (calls markAsRead)
       - System state messages mixed in chronologically (COLB-04)

    5. **NewThreadModal.tsx** (COLB-05): Initiate new thread:
       - Modal with journey selector (dropdown of user's active journeys)
       - Select advisor to message (for now, use a mock advisor user)
       - "Start Thread" creates thread via `services.message.createThread([userId, advisorId], 'b2c', journeyId)`
       - Also sends an initial system message: "Thread created for journey: [Journey Title]"
       - Redirect to new thread view

    6. **Messages page.tsx**:
       - Hero: "Your Conversations" with subtitle about advisor collaboration
       - "New Thread" button opens NewThreadModal
       - ThreadList below
       - Empty state: "No conversations yet. Start a thread with your advisor from any journey."

    7. **Messages [threadId] page.tsx**:
       - Fetch thread by ID
       - Show ThreadView
       - Back link to /messages
       - 404 if thread not found

    8. **System message wiring for journey state changes (COLB-04)**: When a journey status changes (e.g., via ConfirmJourneyFlow built in Plan 03), the journey service or the confirm/refine/archive action handler must also create a system message in any related messaging thread. Specifically:
       - In the journey confirm/refine/archive flow components (from Plan 03), after successfully updating journey status, look up any messaging threads linked to that journey via `services.message.getThreads()` filtered by `relatedResourceId === journeyId`.
       - For each matching thread, call `services.message.sendMessage(threadId, 'system', 'Journey status changed to [newStatus]')` where the senderId is 'system' (a reserved sender ID for system-generated messages).
       - The MessageBubble component (point 2 above) already handles rendering system messages with distinct styling.
       - If no thread exists for the journey, skip -- system messages are only created in existing threads.

    DESIGN: Messages should feel like a private correspondence, not a chat app. Subtle, refined. Think handwritten letter aesthetic adapted for digital.

    AVOID: Don't build a real-time WebSocket system -- mock services are fine. Don't forget system messages for state changes. Don't forget optimistic updates when sending.
  </action>
  <verify>
    `npm run build` succeeds. Navigate to /messages:
    - Thread list shows existing threads with journey context
    - "New Thread" creates a thread linked to a journey
    - Thread view shows full message history
    - Sending a message appears immediately (optimistic)
    - System messages display differently from user messages
    - Unread indicator works
    - Confirm a journey (from /journeys) and verify a system message appears in the related thread
  </verify>
  <done>
    Journey-based messaging works end-to-end. Threads linked to journeys (COLB-01). Full message history displayed (COLB-03). System state messages for journey changes (COLB-04) -- wired from journey state change handlers to message service, creating system messages in related threads. New thread initiation flow (COLB-05). Optimistic message sending. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Intelligence Brief with magazine-style layout and 4 analytical sections</name>
  <files>
    src/app/(b2c)/intelligence/page.tsx
    src/components/b2c/intelligence/EmotionalTrends.tsx
    src/components/b2c/intelligence/LifestylePatterns.tsx
    src/components/b2c/intelligence/RenewalSignals.tsx
    src/components/b2c/intelligence/ExposureRiskOverview.tsx
  </files>
  <action>
    1. **EmotionalTrends.tsx** (INTL-01): Emotional trend insights:
       - Use Recharts AreaChart to show emotional driver trends over time (mock data: 6-12 monthly data points)
       - Each emotional driver (security, adventure, legacy, recognition, autonomy) as a separate line/area with luxury palette colors
       - Narrative text below chart explaining trends: "Over the past 6 months, your focus on Legacy has strengthened while Adventure has remained steady..."
       - Tooltip on chart points showing exact values
       - Responsive chart (full width on mobile)

    2. **LifestylePatterns.tsx** (INTL-02): Lifestyle pattern visualization:
       - Use Recharts RadarChart showing lifestyle dimension scores (similar to emotional drivers but for lifestyle: Travel, Wellness, Culture, Family, Philanthropy, Finance)
       - Generate mock data from intent profile's priorities and values
       - Narrative text: "Your lifestyle pattern suggests a strong orientation toward Cultural Immersion and Family Legacy..."
       - Visual: elegant radar with sand/rose coloring

    3. **RenewalSignals.tsx** (INTL-03): Renewal cycle signals:
       - Timeline-style display of "renewal signals" -- moments when emotional patterns suggest readiness for change
       - Mock data: 3-4 signal events with dates, descriptions, and related emotional shifts
       - Each signal is a styled card with date, signal name (e.g., "Legacy Reflection Window"), and narrative description
       - Use vertical timeline similar to memory vault but simpler

    4. **ExposureRiskOverview.tsx** (INTL-04): Simplified exposure risk for B2C:
       - NOT technical risk analysis -- plain language for the UHNI
       - Categories: Privacy Exposure (how visible is their data), Travel Risk (geopolitical), Financial Exposure (general risk level)
       - Each category: color-coded indicator (green/amber/red) + one-sentence explanation
       - Mock data based on privacy settings and journey locations
       - Callout card with overall risk summary

    5. **Intelligence page.tsx** (INTL-05): Magazine-style layout:
       - Full-width hero: "Your Intelligence Brief" with date and narrative introduction ("A curated analysis of your emotional landscape and lifestyle patterns")
       - Layout: NOT a grid of cards. Instead, stacked editorial sections with alternating layouts:
         - Section 1: EmotionalTrends (full width, chart + narrative)
         - Section 2: LifestylePatterns (two-column: chart left, narrative right)
         - Section 3: RenewalSignals (full width, timeline style)
         - Section 4: ExposureRiskOverview (full width, callout cards)
       - Each section has a serif heading, thin divider line, generous spacing
       - Framer Motion scroll-triggered animations (sections fade in as you scroll)
       - Think luxury magazine feature article layout (like Monocle or Wallpaper*)

    DESIGN: This is the most "magazine" page in the app. Each section should feel like a feature article spread. Generous whitespace, editorial typography, data visualizations as art.

    AVOID: Don't make this look like an analytics dashboard. No dense metric grids. No small charts crammed together. Each visualization gets breathing room. Don't use bar charts -- use area/radar/line charts for the luxury aesthetic.
  </action>
  <verify>
    `npm run build` succeeds. Navigate to /intelligence:
    - Magazine-style layout with 4 sections
    - Emotional trends: area chart with 5 drivers over time
    - Lifestyle patterns: radar chart
    - Renewal signals: timeline cards
    - Exposure risk: color-coded indicators
    - Scroll animations work
    - Narrative text accompanies each visualization
    - Responsive layout on mobile
  </verify>
  <done>
    Intelligence Brief page with magazine-style editorial layout (INTL-05). Emotional trend insights with area chart (INTL-01). Lifestyle pattern radar chart (INTL-02). Renewal cycle signals timeline (INTL-03). Exposure risk overview with plain language (INTL-04). All sections have narrative text and luxury aesthetic. Build passes.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- /messages: thread list, new thread creation, full message history, system messages
- /intelligence: magazine layout with 4 analytical sections using Recharts
- Messaging threads linked to journeys
- Journey state changes create system messages in related threads
- Intelligence Brief feels like luxury magazine, not dashboard
- All COLB requirements (01, 03, 04, 05) and INTL requirements (01-05) addressed
</verification>

<success_criteria>
1. UHNI can initiate secure messaging thread per journey and see full message history (Success Criteria #9)
2. UHNI can view Intelligence Brief with emotional trends, lifestyle patterns, renewal signals, and exposure risk overview in magazine-style layout (Success Criteria #11)
3. System state messages appear for journey state changes (COLB-04) -- journey confirm/refine/archive triggers system message in related threads
</success_criteria>

<output>
After completion, create `.planning/phases/03-b2c-sovereign-experience/03-05-SUMMARY.md`
</output>
