---
phase: 03-b2c-sovereign-experience
plan: 06
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/app/(b2c)/privacy/page.tsx
  - src/components/b2c/privacy/DiscretionTierSelector.tsx
  - src/components/b2c/privacy/InvisibleItineraryDefault.tsx
  - src/components/b2c/privacy/AdvisorVisibilityScope.tsx
  - src/components/b2c/privacy/InviteFlowModal.tsx
  - src/components/b2c/privacy/RemoveAccessFlow.tsx
  - src/components/b2c/privacy/DataVisibilityRules.tsx
  - src/lib/services/mock/privacy.mock.ts
autonomous: true

must_haves:
  truths:
    - "UHNI can select discretion tier with explanations and set invisible itinerary default toggle"
    - "UHNI can configure advisor visibility scope with per-journey granular controls"
    - "UHNI can restrict advisor access to specific journeys, specific resource types, or everything"
    - "UHNI can invite spouse/heir/advisor with end-to-end flows"
    - "UHNI can view data visibility rules showing what each role can access"
  artifacts:
    - path: "src/app/(b2c)/privacy/page.tsx"
      provides: "Privacy & access control settings page"
      min_lines: 60
    - path: "src/components/b2c/privacy/DiscretionTierSelector.tsx"
      provides: "Discretion tier selection with explanations"
      min_lines: 40
    - path: "src/components/b2c/privacy/AdvisorVisibilityScope.tsx"
      provides: "Advisor visibility with per-journey and per-resource-type granular controls"
      min_lines: 60
    - path: "src/components/b2c/privacy/InviteFlowModal.tsx"
      provides: "Invite spouse/heir/advisor end-to-end flow"
      min_lines: 60
    - path: "src/components/b2c/privacy/DataVisibilityRules.tsx"
      provides: "Data visibility matrix showing role access"
      min_lines: 40
    - path: "src/lib/services/mock/privacy.mock.ts"
      provides: "Mock privacy service implementation"
      min_lines: 40
  key_links:
    - from: "src/components/b2c/privacy/DiscretionTierSelector.tsx"
      to: "src/lib/services/mock/privacy.mock.ts"
      via: "updateSettings"
      pattern: "updateSettings.*discretionTier"
    - from: "src/components/b2c/privacy/AdvisorVisibilityScope.tsx"
      to: "src/lib/services/mock/privacy.mock.ts"
      via: "updateSettings with advisorVisibilityScope and advisorResourcePermissions"
      pattern: "updateSettings.*advisorVisibilityScope|advisorResourcePermissions"
    - from: "src/components/b2c/privacy/InviteFlowModal.tsx"
      to: "src/lib/services/mock/user.mock.ts"
      via: "createUser for invited role"
      pattern: "createUser|invite"
    - from: "src/components/b2c/privacy/DataVisibilityRules.tsx"
      to: "src/lib/rbac/permissions.ts"
      via: "permission matrix display"
      pattern: "getPermissionMatrix|B2C_PERMISSIONS"
---

<objective>
Build the Privacy & Access Control page -- discretion tier selection, invisible itinerary defaults, advisor visibility scope with granular per-journey controls, invite flows for spouse/heir/advisor, remove access, and data visibility rules display. Also create the mock privacy service.

Purpose: Privacy sovereignty is the UHNI's core value proposition. These controls must feel empowering, not burdensome. Every toggle and setting must work end-to-end with clear explanations in plain language.
Output: Working /privacy page with all privacy controls, invite flows, and data visibility rules.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-b2c-sovereign-experience/03-RESEARCH.md
@.planning/phases/03-b2c-sovereign-experience/03-01-SUMMARY.md

@src/lib/types/entities.ts
@src/lib/types/validation.ts
@src/lib/services/interfaces/IPrivacyService.ts
@src/lib/rbac/permissions.ts
@src/app/(b2c)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock privacy service and build discretion tier, invisible itinerary, and advisor visibility controls with granular per-journey settings</name>
  <files>
    src/lib/services/mock/privacy.mock.ts
    src/app/(b2c)/privacy/page.tsx
    src/components/b2c/privacy/DiscretionTierSelector.tsx
    src/components/b2c/privacy/InvisibleItineraryDefault.tsx
    src/components/b2c/privacy/AdvisorVisibilityScope.tsx
  </files>
  <action>
    1. **privacy.mock.ts**: Mock privacy service implementing IPrivacyService:
       - `getSettings(userId)`: get privacy settings from localStorage (key: 'privacy_settings')
       - `updateSettings(userId, data)`: merge and save settings, log audit event
       - `executeGlobalErase(userId)`: delete ALL user data from localStorage across all service keys (journeys, memories, messages, threads, intent profiles, privacy settings), log audit event
       - If no settings exist, create default: { discretionTier: 'Standard', invisibleItineraryDefault: false, dataRetention: 0, analyticsOptOut: false, thirdPartySharing: false, advisorVisibilityScope: [], advisorResourcePermissions: {}, globalEraseRequested: false }
       - The `advisorResourcePermissions` field stores granular per-advisor, per-resource-type controls as: `{ [advisorId]: { journeys: string[] | 'all' | 'none', intelligence: boolean, memories: boolean } }` where `journeys` is either an array of specific journey IDs the advisor can see, 'all', or 'none'
       - Add privacy service to useServices hook

    2. **DiscretionTierSelector.tsx** (PRIV-01): Discretion tier selection:
       - Three large selectable cards (not a dropdown):
         - **High**: "Maximum privacy. Your data is visible only to you. Advisors see minimal context." (rose accent)
         - **Medium**: "Balanced privacy. Advisors can see journey outlines but not personal details." (teal accent)
         - **Standard**: "Open collaboration. Advisors have full context to provide best recommendations." (sand accent)
       - Current tier highlighted with selected state
       - Selecting calls `services.privacy.updateSettings(userId, { discretionTier: tier })`
       - Success feedback (subtle checkmark animation)

    3. **InvisibleItineraryDefault.tsx** (PRIV-02): Toggle for default invisible itinerary:
       - Toggle switch with label: "Make all new journeys invisible by default"
       - Explanation text: "When enabled, newly generated journeys will be hidden from all other roles until you explicitly make them visible."
       - Calls `services.privacy.updateSettings(userId, { invisibleItineraryDefault: value })`
       - Visual feedback on toggle

    4. **AdvisorVisibilityScope.tsx** (PRIV-03, COLB-02): Advisor visibility configuration with granular controls:
       - **Default view** (simple): List of advisors (mock: show 1-2 mock advisor users) with a master on/off toggle per advisor. Toggle controls whether the advisor is included in `advisorVisibilityScope` array. Explanation: "Control which advisors can view your journeys and intelligence brief."
       - **"Advanced Settings" expandable section** (per research pattern #2 progressive disclosure): When expanded, shows per-advisor granular controls:
         - **Per-journey visibility**: For each advisor that is toggled ON, show a list of the UHNI's journeys (fetched from journey service) with individual checkboxes. Each checked journey ID is stored in `advisorResourcePermissions[advisorId].journeys`. An "All Journeys" toggle at the top sets the value to 'all'. Unchecking all sets to 'none'.
         - **Resource type toggles**: For each advisor, show toggles for:
           - "Can view Intelligence Brief" (controls `advisorResourcePermissions[advisorId].intelligence`, default: true when advisor is active)
           - "Can view shared memories" (controls `advisorResourcePermissions[advisorId].memories`, default: false -- memories are private by default)
         - Each toggle change calls `services.privacy.updateSettings(userId, { advisorResourcePermissions: updatedPermissions })`
       - When the master toggle for an advisor is turned OFF, all their granular permissions are also cleared (set to `{ journeys: 'none', intelligence: false, memories: false }`).
       - Visual: indented subsection per advisor with subtle border-left, collapsible via chevron icon.

    5. **Privacy page.tsx**: Main privacy page layout:
       - Hero: "Privacy & Sovereignty" with narrative subtitle about controlling your digital footprint
       - Sections with clear headings and dividers:
         - "Discretion Level" (DiscretionTierSelector)
         - "Journey Visibility" (InvisibleItineraryDefault)
         - "Advisor Access" (AdvisorVisibilityScope)
         - More sections added in Task 2 below
       - Each section has a description explaining why it matters
       - Framer Motion entrance animations per section

    DESIGN: Privacy settings should feel empowering, not bureaucratic. Plain language, not legal jargon. Each control should explain its impact clearly.

    AVOID: Don't use technical permission names (READ, WRITE). Use human language ("can view", "can see"). Don't bunch all settings together -- use clear sections with breathing room. Don't forget to update useServices hook with privacy service.
  </action>
  <verify>
    `npm run build` succeeds. Navigate to /privacy:
    - Discretion tier: 3 cards selectable, selection persists
    - Invisible itinerary toggle: works and persists
    - Advisor visibility: master on/off toggles for advisors, saves to service
    - Advanced Settings: expand to see per-journey checkboxes for each advisor
    - Advanced Settings: toggle "All Journeys" vs individual journey selection
    - Advanced Settings: resource type toggles (Intelligence Brief, shared memories) work per advisor
    - Turning off master advisor toggle clears all granular permissions
    - Privacy settings persist across page refresh (localStorage)
    - Mock privacy service accessible via useServices
  </verify>
  <done>
    Mock privacy service created and integrated with useServices. Discretion tier selector with explanations (PRIV-01). Invisible itinerary default toggle (PRIV-02). Advisor visibility scope configuration with granular per-journey and per-resource-type controls (PRIV-03, COLB-02) -- UHNI controls exactly what each advisor can see at journey level and resource type level. All settings persist via localStorage. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build invite flows, remove access, and data visibility rules</name>
  <files>
    src/components/b2c/privacy/InviteFlowModal.tsx
    src/components/b2c/privacy/RemoveAccessFlow.tsx
    src/components/b2c/privacy/DataVisibilityRules.tsx
  </files>
  <action>
    1. **InviteFlowModal.tsx** (PRIV-04, PRIV-05, PRIV-06): End-to-end invite flows:
       - Modal component that handles inviting spouse, heir, or advisor
       - Props: `role: 'Spouse' | 'LegacyHeir' | 'ElanAdvisor'`
       - Flow:
         a. CTA button ("Invite Spouse", "Invite Heir", "Invite Advisor") opens modal
         b. Modal shows form: name, email address, optional message
         c. Role explanation: what access this role will have (pull from RBAC permission matrix to generate human-readable summary)
         d. "Send Invitation" button:
            - Creates a mock invite code via invite-code service (type: 'b2c', assignedRoles: { b2c: role })
            - Creates a mock user record with the invited role (for demo purposes)
            - Shows success state: "Invitation sent to [email]. They will receive an invite code to join."
            - Adds invited user to relevant lists (e.g., advisor visibility scope, memory sharing options)
         e. Close modal
       - Three CTA buttons on the privacy page trigger this modal with different role props

    2. **RemoveAccessFlow.tsx** (PRIV-07, COLB-06): Remove/restrict access:
       - Section showing currently invited roles (spouse, heir, advisors)
       - Each invited person shows: name, role, access level
       - "Remove Access" button per person:
         a. Confirmation dialog: "Remove [Name]'s access? They will no longer be able to view your data."
         b. On confirm: remove from advisorVisibilityScope, remove from sharingPermissions across memories, mark user relationship as revoked
         c. Success toast: "[Name] has been removed"
       - "Restrict Access" option for advisors (COLB-06): instead of full removal, can limit what advisor sees (removes specific permissions)

    3. **DataVisibilityRules.tsx** (PRIV-09): Visual display of what each role can access:
       - Table/matrix showing:
         - Rows: resources (Journeys, Memories, Intent Profile, Messages, Privacy Settings)
         - Columns: roles (UHNI, Spouse, Legacy Heir, Elan Advisor)
         - Cells: access level (Full Access, View Only, Limited, No Access) with color coding
       - Pull data from RBAC permission matrices (src/lib/rbac/permissions.ts)
       - Transform Permission enums to human-readable text:
         - READ only -> "View Only"
         - READ + WRITE -> "Full Access"
         - No permissions -> "No Access"
         - Specific filters -> "Limited" with tooltip explaining what's filtered
       - Style as a luxury table: serif headers, alternating row backgrounds, generous cell padding
       - Note at bottom: "You can adjust advisor access in the settings above"

    4. **Update privacy page.tsx** to include the new sections:
       - After Advisor Access section:
         - "Your Circle" section with invite buttons (Invite Spouse, Invite Heir, Invite Advisor)
         - List of currently invited people with remove/restrict options
         - "Data Visibility" section with DataVisibilityRules table

    EVERY invite flow is end-to-end: CTA -> form -> submission -> confirmation. No dead buttons.

    AVOID: Don't actually send emails (mock service). Don't show raw permission enums to user. Don't forget to update memory sharing options when new family members are invited.
  </action>
  <verify>
    `npm run build` succeeds. Navigate to /privacy:
    - "Invite Spouse" opens modal, form works, creates mock user/invite
    - "Invite Heir" same flow with heir role
    - "Invite Advisor" same flow with advisor role
    - Invited people appear in "Your Circle" list
    - "Remove Access" confirms and removes person
    - Data visibility table shows correct permissions per role
    - All flows complete end-to-end
  </verify>
  <done>
    Invite flows work end-to-end for spouse (PRIV-04), heir (PRIV-05), and advisor (PRIV-06). Remove access flow revokes all permissions (PRIV-07, COLB-06). Data visibility rules display shows role-based access matrix in human-readable format (PRIV-09). All CTAs functional. Build passes.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- /privacy: all sections render with working controls
- Discretion tier, invisible itinerary, advisor scope all persist
- Advisor visibility has granular per-journey and per-resource-type controls (COLB-02)
- Invite flows create mock users/codes for all 3 roles
- Remove access revokes permissions
- Data visibility rules reflect RBAC matrix in human-readable form
- All PRIV requirements (01-07, 09) and COLB requirements (02, 06) addressed
</verification>

<success_criteria>
1. UHNI can select discretion tier with explanations and set invisible itinerary default toggle (Success Criteria #16)
2. UHNI can configure advisor visibility scope with per-journey granular controls -- UHNI controls what each advisor sees at journey and resource-type level (Success Criteria #10, COLB-02)
3. UHNI can invite spouse/heir/advisor with end-to-end flows (Success Criteria #17)
4. UHNI can view data visibility rules showing what each role can access (Success Criteria #19)
</success_criteria>

<output>
After completion, create `.planning/phases/03-b2c-sovereign-experience/03-06-SUMMARY.md`
</output>
