---
phase: 04-b2b-institutional-portal
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - src/app/(b2b)/revenue/page.tsx
  - src/components/b2b/revenue/LicenseTracker.tsx
  - src/components/b2b/revenue/BillingOverview.tsx
  - src/components/b2b/revenue/SLAMonitor.tsx
  - src/components/b2b/revenue/UsageMetrics.tsx
  - src/components/b2b/revenue/ContractRenewals.tsx
  - src/app/(b2b)/layout.tsx
  - src/lib/rbac/b2b-role-guards.tsx
  - src/components/b2b/layouts/B2BRoleGuard.tsx
autonomous: true

must_haves:
  truths:
    - "Institutional Admin can track enterprise licenses per institution"
    - "Institutional Admin can view client billing overview and usage metrics"
    - "Institutional Admin can monitor SLA compliance and contract renewals"
    - "Relationship Manager role enforced per permissions matrix"
    - "Private Banker role enforced per permissions matrix (strategic oversight)"
    - "Family Office Director role enforced per permissions matrix (supervisory)"
    - "Compliance Officer role enforced per permissions matrix (governance gatekeeper)"
    - "Institutional Admin role enforced per permissions matrix (institution-scoped platform control)"
    - "UHNI Portal role enforced per permissions matrix (view-only enterprise view)"
  artifacts:
    - path: "src/app/(b2b)/revenue/page.tsx"
      provides: "Revenue & Contracts hub with license tracking, billing, SLA, usage, renewals"
      min_lines: 60
    - path: "src/components/b2b/revenue/LicenseTracker.tsx"
      provides: "Enterprise license tracking dashboard"
      min_lines: 40
    - path: "src/components/b2b/revenue/BillingOverview.tsx"
      provides: "Per-client billing summary with usage metrics"
      min_lines: 50
    - path: "src/lib/rbac/b2b-role-guards.tsx"
      provides: "B2B role enforcement configuration mapping roles to allowed routes"
      exports: ["B2B_ROLE_ROUTES", "getB2BRoleDefaultRoute", "canAccessB2BRoute"]
    - path: "src/components/b2b/layouts/B2BRoleGuard.tsx"
      provides: "HOC/component that enforces B2B role permissions on page load"
      exports: ["B2BRoleGuard"]
  key_links:
    - from: "src/app/(b2b)/layout.tsx"
      to: "src/components/b2b/layouts/B2BRoleGuard.tsx"
      via: "B2B layout wraps children with role guard"
      pattern: "B2BRoleGuard"
    - from: "src/lib/rbac/b2b-role-guards.tsx"
      to: "src/lib/rbac/permissions.ts"
      via: "role guards use hasPermission for route access checks"
      pattern: "hasPermission"
    - from: "src/app/(b2b)/revenue/page.tsx"
      to: "src/lib/services/mock/contract.mock.ts"
      via: "revenue page fetches contracts and revenue from service"
      pattern: "services\\.contract"
---

<objective>
Build Revenue & Contracts section (REVN-01 through REVN-05) and implement B2B role enforcement across all portal pages (BRLE-01 through BRLE-06): enterprise license tracking, billing overview, SLA monitoring, usage metrics, contract renewals, plus comprehensive role-based access control ensuring each of the 6 B2B roles sees only what their permissions matrix allows.

Purpose: Completes the B2B portal with financial operations visibility and locks down the entire portal with role enforcement — the final piece ensuring every page respects the RBAC matrices defined in Phase 1.

Output: Revenue section with 5 sub-modules and role enforcement guard applied across all B2B routes.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-b2b-institutional-portal/04-RESEARCH.md

Key existing files:
@src/lib/services/mock/contract.mock.ts (from Plan 01 — MockContractService)
@src/lib/types/entities.ts (Contract, RevenueRecord types)
@src/lib/rbac/permissions.ts (B2B permission matrices — all 6 roles defined)
@src/lib/rbac/usePermission.ts (useCan hook)
@src/lib/types/roles.ts (B2BRole enum)
@src/lib/hooks/useAuth.ts (useAuth hook with currentRole, context)
@src/components/b2b/tables/DataTable.tsx (from Plan 01)
@src/components/b2b/layouts/StatsRow.tsx (from Plan 01)
@src/components/b2b/layouts/StatusBadge.tsx (from Plan 01)
@src/app/(b2b)/layout.tsx (B2B layout to add role guard)
@src/components/shared/Card/index.tsx

Prior plan SUMMARYs:
@.planning/phases/04-b2b-institutional-portal/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Revenue & Contracts section (license tracking, billing, SLA, usage, renewals)</name>
  <files>
    src/app/(b2b)/revenue/page.tsx
    src/components/b2b/revenue/LicenseTracker.tsx
    src/components/b2b/revenue/BillingOverview.tsx
    src/components/b2b/revenue/SLAMonitor.tsx
    src/components/b2b/revenue/UsageMetrics.tsx
    src/components/b2b/revenue/ContractRenewals.tsx
  </files>
  <action>
    **Step 1: Extend MockContractService if needed**

    Ensure the MockContractService (from Plan 01) has all needed methods. If missing, add:
    - `getActiveLicenses(institutionId: string)` — returns contracts as license records
    - `getUsageMetrics(institutionId: string)` — returns mock usage data (active users, API calls, storage used, journeys created)
    - `getSLAMetrics(institutionId: string)` — returns mock SLA data (uptime %, response time, resolution time)

    Add mock data for these if not seeded in Plan 01. Also extend the IContractService interface if needed.

    Seed mock data:
    - 2-3 contracts (Platinum annual, Gold per-user, etc.)
    - 8-10 revenue records across 6 months
    - Usage metrics: { activeUsers: 247, totalUsers: 310, apiCalls: 12400, storageUsedMB: 890, storageCapacityMB: 5000, journeysCreated: 89 }
    - SLA metrics: { uptimePercent: 99.97, avgResponseMs: 120, incidentCount: 2, resolvedCount: 2, slaTarget: 99.9 }

    **Step 2: Revenue Page**

    Create `src/app/(b2b)/revenue/page.tsx` as `'use client'`.

    Page structure:
    - Header: "Revenue & Contracts" title
    - Permission gate: Revenue section requires `can(Permission.READ, 'contract')` OR `can(Permission.READ, 'revenue')`. InstitutionalAdmin, PrivateBanker, and FamilyOfficeDirector have access (per permission matrix). RM does NOT have revenue access.
    - StatsRow: Total Revenue (sum of all revenue records), Active Contracts, License Utilization (activeUsers/totalUsers %), SLA Compliance (uptimePercent)
    - Tabbed interface with 5 tabs:
      - Licenses (default)
      - Billing
      - SLA
      - Usage
      - Renewals

    **Step 3: LicenseTracker component**

    Create `src/components/b2b/revenue/LicenseTracker.tsx` (REVN-01).

    Shows enterprise license status:
    - Summary cards: Active Licenses count, Total License Seats, Seats Used, Utilization %
    - DataTable of contracts/licenses: Contract ID, Tier (StatusBadge), Annual Fee (formatted currency), Per-User Fee, Start Date, End Date, Status (StatusBadge: Active=teal, Expired=red, Pending Renewal=gold)
    - Recharts BarChart showing license utilization over time (mock 6 months of data)
    - "View Contract Details" action per row (opens modal with full contract info)

    **Step 4: BillingOverview component**

    Create `src/components/b2b/revenue/BillingOverview.tsx` (REVN-02).

    Per-client billing summary:
    - Recharts AreaChart showing revenue trend over last 6 months (from revenue records)
    - DataTable of revenue records: Period, Amount (formatted with currency), Type (Subscription/Usage/One-Time), Paid Status (paid date or "Pending"), Contract Reference
    - Summary: Total billed, total paid, outstanding amount
    - Breakdown by revenue type: Recharts PieChart (Subscription vs Usage vs One-Time)

    **Step 5: SLAMonitor component**

    Create `src/components/b2b/revenue/SLAMonitor.tsx` (REVN-03).

    SLA compliance dashboard:
    - Key metrics cards: Uptime % (with green/red indicator based on target), Avg Response Time (ms), Incidents This Month, Resolution Rate
    - Recharts LineChart showing uptime trend over 12 months (mock data: 99.90-99.99 range)
    - SLA target indicator line on chart (e.g., 99.9% target as dashed horizontal line)
    - Incident log: Small DataTable of recent incidents (date, description, duration, status: Resolved/Open)
    - If uptime below SLA target, show red warning banner

    **Step 6: UsageMetrics component**

    Create `src/components/b2b/revenue/UsageMetrics.tsx` (REVN-04).

    Platform usage statistics:
    - Key metrics: Active Users, Total Users, API Calls (this month), Storage Used, Journeys Created
    - Recharts BarChart: Monthly active users over 6 months
    - Recharts AreaChart: API calls trend over 6 months
    - Storage utilization bar: Visual progress bar showing storage used / capacity
    - "Top Features" list: Most used features (mock data — e.g., "Journey Generation: 89 uses", "Client Onboarding: 34 uses", "Vault Access: 156 uses")

    **Step 7: ContractRenewals component**

    Create `src/components/b2b/revenue/ContractRenewals.tsx` (REVN-05).

    Upcoming renewals and status:
    - DataTable of contracts sorted by end date (soonest first): Contract, Tier, End Date, Days Until Renewal, Status, Annual Value
    - Contracts expiring within 30 days: highlighted with amber background
    - Contracts expired: highlighted with red background
    - "Initiate Renewal" action button per contract (opens confirmation modal -> updates contract status to "Pending Renewal" -> toast success)
    - Calendar-style upcoming renewals view: Simple list grouped by month showing which contracts renew when
  </action>
  <verify>
    Run `npm run build`. Navigate to `/revenue`:
    - Stats row shows revenue metrics
    - Licenses tab shows license/contract data in DataTable with utilization chart
    - Billing tab shows revenue trend chart and breakdown
    - SLA tab shows uptime metrics and incident log
    - Usage tab shows platform usage statistics and charts
    - Renewals tab shows upcoming contract renewals with expiry warnings
    - Page access denied for RM role (no revenue permission)
    - Page accessible for InstitutionalAdmin, PrivateBanker roles
  </verify>
  <done>
    Revenue & Contracts section complete with 5 sub-modules. Enterprise licenses tracked. Billing overview shows revenue trends. SLA monitoring shows compliance. Usage metrics display platform activity. Contract renewals show upcoming expirations. REVN-01 through REVN-05 complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: B2B role enforcement across all portal pages (BRLE-01 through BRLE-06)</name>
  <files>
    src/lib/rbac/b2b-role-guards.tsx
    src/components/b2b/layouts/B2BRoleGuard.tsx
    src/app/(b2b)/layout.tsx
  </files>
  <action>
    **Step 1: Define B2B role route access configuration**

    Create `src/lib/rbac/b2b-role-guards.tsx`.

    Define which routes each B2B role can access, based on the permission matrices:

    ```typescript
    import { B2BRole } from '@/lib/types/roles';

    interface RouteAccess {
      path: string;
      label: string;
      requiredResource: Resource;
      requiredAction: Permission;
    }

    export const B2B_ROUTES: RouteAccess[] = [
      { path: '/portfolio', label: 'Portfolio Dashboard', requiredResource: 'client', requiredAction: Permission.READ },
      { path: '/clients', label: 'Client Management', requiredResource: 'client', requiredAction: Permission.READ },
      { path: '/journeys', label: 'Journey Governance', requiredResource: 'journey', requiredAction: Permission.READ },
      { path: '/risk', label: 'Risk Intelligence', requiredResource: 'risk', requiredAction: Permission.READ },
      { path: '/access', label: 'Access Engineering', requiredResource: 'institution', requiredAction: Permission.CONFIGURE },
      { path: '/vault', label: 'Memory Vault', requiredResource: 'vault', requiredAction: Permission.READ },
      { path: '/revenue', label: 'Revenue & Contracts', requiredResource: 'contract', requiredAction: Permission.READ },
    ];

    // Role -> default landing page after login
    export const B2B_ROLE_DEFAULTS: Record<B2BRole, string> = {
      [B2BRole.RelationshipManager]: '/portfolio',
      [B2BRole.PrivateBanker]: '/portfolio',
      [B2BRole.FamilyOfficeDirector]: '/portfolio',
      [B2BRole.ComplianceOfficer]: '/journeys',
      [B2BRole.InstitutionalAdmin]: '/access',
      [B2BRole.UHNIPortal]: '/portfolio',
    };

    export function canAccessB2BRoute(role: B2BRole, pathname: string): boolean {
      const route = B2B_ROUTES.find(r => pathname.startsWith(r.path));
      if (!route) return false;
      return hasPermission(role, route.requiredAction, route.requiredResource, 'b2b');
    }

    export function getB2BNavItems(role: B2BRole): RouteAccess[] {
      return B2B_ROUTES.filter(route =>
        hasPermission(role, route.requiredAction, route.requiredResource, 'b2b')
      );
    }
    ```

    Expected access per role (derived from existing permission matrices):
    - **RelationshipManager**: portfolio, clients, journeys, risk, vault (NOT access, NOT revenue)
    - **PrivateBanker**: portfolio, clients (READ), journeys (READ), risk (READ), revenue (READ) (NOT access, NOT vault)
    - **FamilyOfficeDirector**: portfolio, clients (READ), journeys (READ), risk (READ), access (CONFIGURE), revenue (READ)
    - **ComplianceOfficer**: clients (READ), journeys (READ + APPROVE), risk (READ), audit logs (NOT portfolio clients WRITE, NOT access config, NOT vault, NOT revenue)
    - **InstitutionalAdmin**: access (CONFIGURE), revenue (contract WRITE), audit (NOT clients, NOT journeys, NOT risk, NOT vault)
    - **UHNIPortal**: portfolio (own only), journeys (READ own) — minimal view-only access

    NOTE: If the permission matrix doesn't give ComplianceOfficer READ on client, they can still see journeys page. Adjust route access logic to be generous for READ operations — ComplianceOfficer should see portfolio and journeys at minimum. Add `'client': [Permission.READ]` to ComplianceOfficer in permissions.ts if not already present (check — it IS already there).

    **Step 2: Create B2BRoleGuard component**

    Create `src/components/b2b/layouts/B2BRoleGuard.tsx`.

    ```typescript
    'use client';

    import { useAuth } from '@/lib/hooks/useAuth';
    import { usePathname, useRouter } from 'next/navigation';
    import { canAccessB2BRoute, B2B_ROLE_DEFAULTS } from '@/lib/rbac/b2b-role-guards';
    import { B2BRole } from '@/lib/types/roles';

    export function B2BRoleGuard({ children }: { children: React.ReactNode }) {
      const { currentRole, context } = useAuth();
      const pathname = usePathname();
      const router = useRouter();

      // Only enforce in B2B context
      if (context !== 'b2b' || !currentRole) {
        return <>{children}</>;
      }

      const b2bRole = currentRole as B2BRole;

      // Check if current role can access current route
      if (!canAccessB2BRoute(b2bRole, pathname)) {
        // Redirect to role's default page
        const defaultRoute = B2B_ROLE_DEFAULTS[b2bRole] || '/portfolio';

        return (
          <div className="flex flex-col items-center justify-center min-h-[60vh] text-center">
            <div className="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mb-6">
              <span className="text-2xl text-rose-600">!</span>
            </div>
            <h2 className="text-2xl font-serif text-slate-900 mb-2">Access Restricted</h2>
            <p className="text-slate-600 font-sans max-w-md mb-6">
              Your role ({b2bRole}) does not have permission to access this section.
            </p>
            <button
              onClick={() => router.push(defaultRoute)}
              className="px-6 py-2 bg-rose-700 text-white rounded-md font-sans text-sm hover:bg-rose-800 transition-colors"
            >
              Go to Dashboard
            </button>
          </div>
        );
      }

      return <>{children}</>;
    }
    ```

    **Step 3: Update B2B Layout with role guard and dynamic sidebar**

    Update `src/app/(b2b)/layout.tsx`:

    1. Wrap the main content area with `<B2BRoleGuard>{children}</B2BRoleGuard>`
    2. Update the B2BSidebar to use `getB2BNavItems(currentRole)` to dynamically show only the nav items the current role can access. This means the sidebar nav adapts per role.
    3. Import `useAuth` to get current role in the sidebar
    4. Show current user's role name in the bottom user section of the sidebar
    5. Add active route highlighting: Compare `pathname` (from `usePathname()`) with nav item href. Active item gets `bg-slate-100 text-slate-900 font-medium` classes.

    The sidebar should now dynamically filter nav items:
    - RM sees: Portfolio, Clients, Journeys, Risk, Vault
    - ComplianceOfficer sees: Portfolio, Clients, Journeys, Risk
    - InstitutionalAdmin sees: Portfolio, Access, Revenue
    - UHNIPortal sees: Portfolio, Journeys
    - etc.

    **Step 4: Verify role enforcement works**

    After implementation, the expected behavior per role:

    | Role | Can Access | Cannot Access | Default Page |
    |------|-----------|---------------|-------------|
    | RelationshipManager | portfolio, clients, journeys, risk, vault | access, revenue | /portfolio |
    | PrivateBanker | portfolio, clients, journeys, risk, revenue | access, vault | /portfolio |
    | FamilyOfficeDirector | portfolio, clients, journeys, risk, access, revenue | vault | /portfolio |
    | ComplianceOfficer | portfolio, clients, journeys, risk | access, vault, revenue | /journeys |
    | InstitutionalAdmin | access, revenue | portfolio(?), clients, journeys, risk, vault | /access |
    | UHNIPortal | portfolio, journeys | clients, risk, access, vault, revenue | /portfolio |

    Note on InstitutionalAdmin: They have `audit: [READ]` which may give them portfolio access. The guard should be slightly generous — if a role has ANY READ permission on the route's resource, grant access. Check permissions.ts: InstitutionalAdmin has `institution: CONFIGURE`, `user: READ/WRITE/ASSIGN`, `contract: READ/WRITE`, `audit: READ`, `privacy: CONFIGURE`. They should see Access and Revenue pages. For Portfolio, since they have `user: READ`, they could see a simplified portfolio. Make InstitutionalAdmin see portfolio as well (they need to see the institution overview).

    To handle this, add `'user': [Permission.READ]` as sufficient for `/portfolio` access (since the portfolio is about users/clients).

    Actually, simpler: give `/portfolio` access to ALL B2B roles (it's the landing page, everyone should see at least a summary). Only restrict sensitive operational pages.

    Revised route permissions:
    - `/portfolio`: Allow all B2B roles (no gate, or gate on any B2B role existing)
    - `/clients`: `client: READ`
    - `/journeys`: `journey: READ`
    - `/risk`: `risk: READ`
    - `/access`: `institution: CONFIGURE` OR `user: ASSIGN` (admin operations)
    - `/vault`: `vault: READ`
    - `/revenue`: `contract: READ` OR `revenue: READ`
  </action>
  <verify>
    Run `npm run build`. Test role enforcement per permission matrix for all 6 roles:
    - **RelationshipManager (BRLE-01)**: sidebar shows Portfolio, Clients, Journeys, Risk, Vault. No Access or Revenue links. Can create clients, initiate journeys, full operational control.
    - **PrivateBanker (BRLE-02)**: sidebar shows Portfolio, Clients (read-only), Journeys (read-only), Risk (read-only), Revenue (read-only). No Access or Vault links. Strategic oversight — can view but not modify.
    - **FamilyOfficeDirector (BRLE-03)**: sidebar shows Portfolio, Clients (read-only), Revenue (read-only). Supervisory role — limited to portfolio overview and financial visibility.
    - **ComplianceOfficer (BRLE-04)**: sidebar shows Portfolio, Clients, Journeys, Risk. No Access, Vault, or Revenue links. Can approve/reject journeys at COMPLIANCE_REVIEW stage.
    - **InstitutionalAdmin (BRLE-05)**: sidebar shows Portfolio, Access, Revenue. No Clients, Journeys, Risk, Vault links. Platform control — manages permissions and contracts.
    - **UHNIPortal (BRLE-06)**: sidebar shows Portfolio only. View-only enterprise view — read-only access to their own portfolio data.
    - Revenue page at `/revenue` accessible for InstitutionalAdmin, PrivateBanker, FamilyOfficeDirector. Shows all 5 tabs with charts and tables
    - Navigating to any restricted route directly shows "Access Restricted" page with redirect
    - Active route highlighted in sidebar
  </verify>
  <done>
    Revenue & Contracts section delivers 5 sub-modules (REVN-01 through REVN-05). B2B role enforcement guards every route, sidebar dynamically adapts per role, and restricted pages show access denied with redirect. BRLE-01 through BRLE-06 complete — all 6 B2B roles enforced per permission matrices.
  </done>
</task>

</tasks>

<verification>
- Revenue section at `/revenue` shows 5 tabs: Licenses, Billing, SLA, Usage, Renewals
- License tracker shows contract/license data with utilization chart
- Billing overview shows revenue trends and breakdown
- SLA monitor shows uptime metrics with trend chart
- Usage metrics show platform activity statistics
- Contract renewals show upcoming expirations with warnings
- B2B sidebar dynamically filters nav items per current role
- Each B2B role sees only permitted pages (RM cannot access revenue, ComplianceOfficer cannot access vault, etc.)
- Restricted page access shows "Access Restricted" message with redirect button
- Active route highlighted in sidebar navigation
- Role name displayed in sidebar user section
</verification>

<success_criteria>
All 11 remaining requirements met: REVN-01 through REVN-05 (revenue & contracts) and BRLE-01 through BRLE-06 (role enforcement for all 6 B2B roles). The B2B portal is complete with full RBAC enforcement — every page, every action, every nav item respects the permission matrices from Phase 1.
</success_criteria>

<output>
After completion, create `.planning/phases/04-b2b-institutional-portal/04-05-SUMMARY.md`
</output>
