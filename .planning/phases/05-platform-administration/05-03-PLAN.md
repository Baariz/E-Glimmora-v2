---
phase: 05-platform-administration
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/app/(admin)/audit/page.tsx
  - src/app/(admin)/system/page.tsx
  - src/app/(admin)/revenue/page.tsx
  - src/lib/services/interfaces/ISystemHealthService.ts
  - src/lib/services/mock/system-health.mock.ts
  - src/lib/services/config.ts
  - src/lib/hooks/useServices.ts
  - src/lib/services/interfaces/index.ts
  - src/lib/state-machines/approval-routing-config.ts
  - src/lib/branding/theme-tokens.ts
  - src/lib/branding/institutional-themes.ts
  - src/components/admin/governance/ApprovalChainViewer.tsx
  - src/components/admin/governance/VersionHistoryPanel.tsx
  - src/components/admin/governance/BrandingControls.tsx
  - src/components/admin/monitoring/SystemHealthCard.tsx
  - src/components/admin/monitoring/UptimeChart.tsx
  - src/components/admin/monitoring/ErrorRateChart.tsx
  - src/components/admin/AdminRoleGuard.tsx
autonomous: true

must_haves:
  truths:
    - "Super Admin can search and filter platform-wide audit logs with entity type, action, user, and timestamp filters"
    - "Super Admin can view system health monitoring with uptime percentage, error rate, response time, and active sessions"
    - "Super Admin can view revenue/billing overview across all institutions with total revenue, revenue by tier, and monthly trends"
    - "Super Admin role enforcement prevents non-admin users from accessing admin routes"
    - "Multi-level approval routing is configured per resource type with configurable approval chains"
    - "Institutional branding controls allow setting primary/secondary colors and fonts per institution"
    - "Role-based UI exposure ensures admin nav and features only visible to SuperAdmin role"
  artifacts:
    - path: "src/app/(admin)/audit/page.tsx"
      provides: "Platform-wide audit log viewer with multi-filter DataTable"
      min_lines: 150
    - path: "src/app/(admin)/system/page.tsx"
      provides: "System health monitoring dashboard with Recharts"
      min_lines: 120
    - path: "src/app/(admin)/revenue/page.tsx"
      provides: "Cross-institution revenue/billing overview with charts"
      min_lines: 120
    - path: "src/lib/services/interfaces/ISystemHealthService.ts"
      provides: "System health service interface"
      min_lines: 20
    - path: "src/lib/services/mock/system-health.mock.ts"
      provides: "Mock system health data generator"
      min_lines: 60
    - path: "src/lib/state-machines/approval-routing-config.ts"
      provides: "Configurable multi-level approval chains per institution"
      min_lines: 80
    - path: "src/lib/branding/theme-tokens.ts"
      provides: "Design token types and CSS variable application function"
      min_lines: 50
    - path: "src/components/admin/AdminRoleGuard.tsx"
      provides: "Admin route guard enforcing SuperAdmin role"
      min_lines: 40
  key_links:
    - from: "src/app/(admin)/audit/page.tsx"
      to: "services.audit.getAll"
      via: "Load all audit events then filter client-side"
      pattern: "audit\\.getAll"
    - from: "src/app/(admin)/system/page.tsx"
      to: "services.systemHealth"
      via: "Load health metrics from new service"
      pattern: "systemHealth"
    - from: "src/app/(admin)/revenue/page.tsx"
      to: "services.contract and services.institution"
      via: "Cross-reference contracts with institutions for revenue aggregation"
      pattern: "contract|institution"
    - from: "src/app/(admin)/layout.tsx"
      to: "AdminRoleGuard"
      via: "Wraps admin children for role enforcement"
      pattern: "AdminRoleGuard"
---

<objective>
Build platform-wide audit logs, system health monitoring, revenue overview, Super Admin role enforcement, and governance infrastructure (approval routing, version history, branding controls).

Purpose: Completes all remaining Phase 5 requirements — ADMN-06 through ADMN-09 (audit, monitoring, revenue, enforcement) and GVRN-01 through GVRN-06 (approval routing, audit trail, compliance, version history, role-based UI, branding). This plan finishes the platform administration layer.
Output: Three new admin pages (audit, system, revenue), system health service, approval routing configuration, institutional branding engine, and admin role enforcement guard.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-platform-administration/05-01-SUMMARY.md
@.planning/phases/05-platform-administration/05-02-SUMMARY.md

Key references:
@src/lib/services/mock/audit.mock.ts — Existing audit service with getAll, getByUser, getByContext, getByResource
@src/lib/services/config.ts — Service registry (needs systemHealth added)
@src/lib/hooks/useServices.ts — Hook (needs systemHealth added)
@src/lib/state-machines/journey-workflow.ts — State machine pattern to extend for approval routing
@src/lib/rbac/permissions.ts — hasPermission function, ADMIN_PERMISSIONS matrix
@src/lib/types/entities.ts — AuditEvent, Contract, RevenueRecord, Institution types
@src/lib/types/permissions.ts — Permission and Resource enums
@src/components/b2b/tables/DataTable.tsx — For audit log table
@src/components/b2b/layouts/StatsRow.tsx — For stats
@src/components/b2b/revenue/UsageMetrics.tsx — Recharts pattern to follow for monitoring charts
@src/components/b2b/layouts/B2BRoleGuard.tsx — Pattern to follow for AdminRoleGuard
@src/app/(admin)/layout.tsx — Needs AdminRoleGuard integration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Platform-wide audit logs, system health monitoring, and revenue overview pages</name>
  <files>
    src/app/(admin)/audit/page.tsx
    src/app/(admin)/system/page.tsx
    src/app/(admin)/revenue/page.tsx
    src/lib/services/interfaces/ISystemHealthService.ts
    src/lib/services/mock/system-health.mock.ts
    src/lib/services/config.ts
    src/lib/hooks/useServices.ts
    src/lib/services/interfaces/index.ts
  </files>
  <action>
  **ISystemHealthService Interface:**

  Create `src/lib/services/interfaces/ISystemHealthService.ts`:
  ```typescript
  interface SystemMetrics {
    uptime: number;          // percentage 0-100
    errorRate: number;       // percentage 0-100
    avgResponseTime: number; // milliseconds
    activeSessions: number;
    apiCallsToday: number;
    storageUsedGB: number;
    storageCapacityGB: number;
  }

  interface HealthTimePoint {
    time: string;  // e.g., "00:00", "04:00"
    uptime: number;
    errorRate: number;
    responseTime: number;
  }

  interface ISystemHealthService {
    getCurrentMetrics(): Promise<SystemMetrics>;
    getHealthTimeline(hours: number): Promise<HealthTimePoint[]>;
  }
  ```

  **MockSystemHealthService:**

  Create `src/lib/services/mock/system-health.mock.ts`:
  1. Extends BaseMockService
  2. `getCurrentMetrics()`: returns static healthy metrics — uptime: 99.97, errorRate: 0.03, avgResponseTime: 142, activeSessions: 89, apiCallsToday: 12847, storageUsedGB: 23.4, storageCapacityGB: 100
  3. `getHealthTimeline(hours)`: generates mock time series data — creates data points every 4 hours with slight variations (uptime 99.90-99.99, errorRate 0.01-0.08, responseTime 120-180). Use deterministic generation (not random each call) by seeding from hour values.

  **Register in service config and useServices:**
  - Add ISystemHealthService import and MockSystemHealthService to `config.ts` service registry
  - Add systemHealth to `useServices.ts` hook
  - Export ISystemHealthService from `interfaces/index.ts`

  **Audit Log Page (audit/page.tsx):**

  Create `src/app/(admin)/audit/page.tsx`:
  1. Page header: "Platform Audit Logs" with description "Complete audit trail across all platform operations"
  2. Filter bar (NOT in DataTable, above it) with:
     - Resource Type: select dropdown with "All", "client", "journey", "risk", "user", "institution", "invite", "vault" etc.
     - Action: select dropdown with "All", "CREATE", "READ", "UPDATE", "DELETE", "APPROVE"
     - Context: select dropdown with "All", "b2c", "b2b", "admin"
     - Date Range: two date inputs (from/to) — filter events within range
     - "Clear Filters" text button
  3. Stats row: Total Events, Creates, Updates, Deletes, Approvals — computed from filtered data
  4. DataTable with columns:
     - Timestamp: formatted with date-fns `format(date, 'MMM d, HH:mm:ss')`
     - Event: the event string (e.g., "client.create") with colored dot (green=CREATE, blue=READ, amber=UPDATE, red=DELETE, teal=APPROVE)
     - Resource: resourceType + truncated resourceId
     - User: truncated userId with tooltip (full ID)
     - Context: badge (b2c=rose, b2b=teal, admin=slate)
     - Details: expandable row showing previousState/newState as formatted JSON (if present) and metadata
  5. Load all events via `services.audit.getAll()`, apply client-side filters
  6. Sort by timestamp descending (newest first)
  7. Page size 25

  **System Health Page (system/page.tsx):**

  Create `src/app/(admin)/system/page.tsx`:
  1. Page header: "System Health" with current status indicator (green dot + "All Systems Operational" or yellow dot + "Degraded" based on metrics)
  2. Metrics cards row (4 cards):
     - Uptime: percentage with green/amber/red color (>99.9=green, >99=amber, else red)
     - Error Rate: percentage with green/amber/red (opposite — <0.1=green, <1=amber, else red)
     - Avg Response: milliseconds with green/amber/red (<200=green, <500=amber, else red)
     - Active Sessions: count
  3. Two Recharts charts side by side (responsive, stack on mobile):
     - **Uptime Chart**: AreaChart (similar to UsageMetrics.tsx pattern) showing uptime over last 24 hours with teal gradient fill
     - **Error Rate Chart**: LineChart showing error rate over last 24 hours with rose line
  4. Additional metrics section: API calls today, storage usage with progress bar (usedGB/capacityGB)
  5. Load data from systemHealth service on mount
  6. Loading state

  **Revenue Overview Page (revenue/page.tsx):**

  Create `src/app/(admin)/revenue/page.tsx`:
  1. Page header: "Revenue Overview" with description "Cross-institution billing and revenue summary"
  2. Load all institutions and contracts from respective services
  3. Compute aggregated metrics:
     - Total Annual Revenue: sum of all contract annualFees
     - Revenue by Tier: group contracts by tier (Platinum/Gold/Silver), sum annualFees
     - Active Contracts: count of active contracts
     - Pending Renewals: count of contracts with status "Pending Renewal"
  4. Stats row: Total Revenue (formatted as currency), Active Contracts, Institutions, Pending Renewals
  5. Revenue by Tier: Recharts BarChart — horizontal bars showing revenue by tier (Platinum=gold fill, Gold=amber, Silver=slate)
  6. Institution Revenue Table: DataTable with columns:
     - Institution Name: from institutions service (lookup by institutionId)
     - Tier: badge
     - Contract Status: StatusBadge
     - Annual Fee: currency formatted
     - Per-User Fee: currency formatted
     - Start Date / End Date
  7. Search by institution name
  8. Loading state
  </action>
  <verify>
  - `npm run build` completes without errors
  - Audit page shows all events with filters working (filter by resource type, action, context, date range)
  - System page shows health metrics and Recharts charts
  - Revenue page shows aggregated metrics and institution revenue table
  - System health service registered and accessible via useServices
  </verify>
  <done>
  Audit log page displays all platform events with multi-dimensional filtering (resource type, action, context, date range). System health page shows uptime, error rate, response time with Recharts visualizations. Revenue page shows cross-institution revenue with tier breakdown and contract details.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin role enforcement and governance infrastructure</name>
  <files>
    src/components/admin/AdminRoleGuard.tsx
    src/app/(admin)/layout.tsx
    src/lib/state-machines/approval-routing-config.ts
    src/lib/branding/theme-tokens.ts
    src/lib/branding/institutional-themes.ts
    src/components/admin/governance/ApprovalChainViewer.tsx
    src/components/admin/governance/VersionHistoryPanel.tsx
    src/components/admin/governance/BrandingControls.tsx
    src/components/admin/monitoring/SystemHealthCard.tsx
    src/components/admin/monitoring/UptimeChart.tsx
    src/components/admin/monitoring/ErrorRateChart.tsx
  </files>
  <action>
  **AdminRoleGuard Component:**

  Create `src/components/admin/AdminRoleGuard.tsx` following the B2BRoleGuard pattern:
  1. Uses `useAuth()` hook to get currentRole and context
  2. Checks if context is 'admin' and role is AdminRole.SuperAdmin
  3. If not authorized: shows access denied message with redirect to home ("/")
  4. If authorized: renders children

  **Update Admin Layout:**

  Update `src/app/(admin)/layout.tsx`:
  1. Import AdminRoleGuard
  2. Wrap `{children}` with `<AdminRoleGuard>{children}</AdminRoleGuard>` inside the main area
  3. This enforces that ALL admin pages require SuperAdmin role

  **Approval Routing Configuration (GVRN-01):**

  Create `src/lib/state-machines/approval-routing-config.ts`:
  1. Define `ApprovalStep` type: `{ role: Role; permission: { action: Permission; resource: Resource }; label: string; required: boolean }`
  2. Define `ApprovalChain` type: `{ id: string; name: string; resourceType: Resource; institutionId?: string; steps: ApprovalStep[]; active: boolean }`
  3. Define default approval chains:
     - `standard-journey`: Journey approval — Step 1: RM Review (RelationshipManager, WRITE journey), Step 2: Compliance Approval (ComplianceOfficer, APPROVE journey)
     - `high-value-journey`: High-value journey — adds Step 3: Private Banker Sign-off (PrivateBanker, APPROVE journey)
     - `client-onboarding`: Client onboarding — Step 1: RM Submit (RelationshipManager, WRITE client), Step 2: Compliance Check (ComplianceOfficer, APPROVE client)
  4. Export functions:
     - `getApprovalChains(): ApprovalChain[]` — returns all configured chains
     - `getApprovalChain(resourceType: Resource, institutionId?: string): ApprovalChain | null` — finds matching active chain
     - `getApprovalStepForRole(chain: ApprovalChain, role: Role): ApprovalStep | null` — finds step for given role

  **Institutional Branding (GVRN-06):**

  Create `src/lib/branding/theme-tokens.ts`:
  1. Define `BrandingTheme` interface: `{ institutionId: string; colors: { primary: string; secondary: string; accent: string }; typography: { headingFont: string; bodyFont: string }; logo?: string }`
  2. Define `DEFAULT_THEME` constant with Elan default colors (rose-800, teal-700, gold-600)
  3. Export `applyInstitutionalTheme(theme: BrandingTheme)` — sets CSS variables on document.documentElement: `--color-brand-primary`, `--color-brand-secondary`, `--color-brand-accent`, `--font-heading`, `--font-body`
  4. Export `resetToDefaultTheme()` — applies DEFAULT_THEME
  5. Export `loadInstitutionalTheme(institutionId: string)` — loads from localStorage or falls back to default

  Create `src/lib/branding/institutional-themes.ts`:
  1. Define 3-4 sample institutional themes (e.g., "Meridian Private Bank" with navy/gold, "Hartwell Family Office" with forest-green/cream)
  2. Export `getInstitutionalThemes(): BrandingTheme[]`
  3. Export `getThemeForInstitution(institutionId: string): BrandingTheme`

  **BrandingControls Component (GVRN-06):**

  Create `src/components/admin/governance/BrandingControls.tsx`:
  1. Props: `institutionId: string`
  2. Shows current branding theme for institution (primary, secondary, accent colors as swatches)
  3. Color picker inputs (HTML native `<input type="color">`) for primary, secondary, accent
  4. Font selection: dropdown with available fonts
  5. "Preview" button: applies theme temporarily via `applyInstitutionalTheme`
  6. "Save" button: persists to localStorage keyed by institutionId
  7. "Reset to Default" button: resets to Elan defaults

  **ApprovalChainViewer Component (GVRN-01, GVRN-03):**

  Create `src/components/admin/governance/ApprovalChainViewer.tsx`:
  1. Props: `chains: ApprovalChain[]`
  2. Renders each chain as a visual flow: horizontal steps connected by arrows (→)
  3. Each step shows: role badge, label, required/optional indicator
  4. Color-coded by role: RM=teal, ComplianceOfficer=amber, PrivateBanker=slate
  5. "Active" badge on active chains
  6. Read-only display for v1 (no editing — chains are configuration-driven)

  **VersionHistoryPanel Component (GVRN-04):**

  Create `src/components/admin/governance/VersionHistoryPanel.tsx`:
  1. Generic reusable component (not journey-specific)
  2. Props: `versions: Array<{ id: string; versionNumber: number; modifiedBy: string; createdAt: string; status: string; approvedBy?: string; rejectedBy?: string; rejectionReason?: string }>`
  3. Renders as vertical timeline with version numbers, dates, status badges, and modifier info
  4. Current version highlighted
  5. This extends/generalizes the B2B VersionHistory component pattern

  **Extract chart components for reuse:**

  Create `src/components/admin/monitoring/SystemHealthCard.tsx`:
  1. Health summary card with overall status (Healthy/Degraded/Critical), uptime %, error rate, response time
  2. Color-coded status indicator (green/amber/red)

  Create `src/components/admin/monitoring/UptimeChart.tsx`:
  1. Recharts AreaChart component for uptime visualization
  2. Props: `data: HealthTimePoint[]`
  3. Teal gradient fill, responsive container

  Create `src/components/admin/monitoring/ErrorRateChart.tsx`:
  1. Recharts LineChart for error rate
  2. Props: `data: HealthTimePoint[]`
  3. Rose line, responsive container

  NOTE: The system health page (Task 1) should import and use these extracted components. If Task 1 is implemented first, it may inline the charts. In that case, refactor the inline charts into these components during this task, and update the system page to import them.
  </action>
  <verify>
  - `npm run build` completes without errors
  - Admin routes blocked for non-SuperAdmin roles (AdminRoleGuard works)
  - Approval chains load from configuration and display in viewer component
  - Branding controls render color pickers and preview applies CSS variables
  - SystemHealthCard, UptimeChart, ErrorRateChart render correctly
  - VersionHistoryPanel renders version timeline
  </verify>
  <done>
  Admin role guard enforces SuperAdmin-only access to all admin routes. Approval routing configuration defines multi-level chains per resource type. Institutional branding engine applies custom colors/fonts via CSS variables with preview and save. Governance components (ApprovalChainViewer, VersionHistoryPanel, BrandingControls) are reusable. Monitoring chart components extracted for the system health page.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` — no TypeScript errors, no build failures
2. Navigate to /audit — all events displayed, filters work (resource type, action, context, date range), stats row accurate
3. Navigate to /system — health metrics display, Recharts charts render uptime and error rate trends
4. Navigate to /revenue — aggregated stats, tier breakdown chart, institution revenue table
5. Switch to non-SuperAdmin role — admin routes show access denied, redirect to home
6. Switch back to SuperAdmin — full access restored
7. Check approval routing config — chains defined, viewer displays steps with role badges and arrows
8. Open branding controls — color pickers work, preview applies CSS variables, reset restores defaults
9. Version history panel — renders timeline with version numbers and status
10. All admin pages use consistent layout with active nav highlighting
</verification>

<success_criteria>
- ADMN-06 satisfied: Super Admin can search and filter platform-wide audit logs with entity/action/user/timestamp filters
- ADMN-07 satisfied: Super Admin can view system health monitoring with uptime, performance, and error tracking
- ADMN-08 satisfied: Super Admin can view revenue/billing overview across all institutions
- ADMN-09 satisfied: Super Admin role enforcement grants full platform access, blocks others
- GVRN-01 satisfied: Multi-level approval routing configured per institution with approval chains
- GVRN-02 satisfied: Every state change logged immutably in audit trail (verified across all admin actions)
- GVRN-03 satisfied: Compliance workflow integrated — ComplianceOfficer step in approval chains
- GVRN-04 satisfied: Version history tracked via generic VersionHistoryPanel component
- GVRN-05 satisfied: Role-based UI exposure — AdminRoleGuard + useCan() ensures UI elements per role
- GVRN-06 satisfied: Institutional branding controls with custom colors/fonts via CSS variables
</success_criteria>

<output>
After completion, create `.planning/phases/05-platform-administration/05-03-SUMMARY.md`
</output>
