---
phase: 04-b2b-institutional-portal
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(b2b)/journeys/page.tsx
  - src/app/(b2b)/journeys/[id]/page.tsx
  - src/app/(b2b)/journeys/simulate/page.tsx
  - src/components/b2b/workflows/JourneyGovernancePanel.tsx
  - src/components/b2b/workflows/VersionHistory.tsx
  - src/components/b2b/workflows/VersionDiff.tsx
  - src/components/b2b/workflows/ExecutionTracker.tsx
  - src/components/b2b/workflows/PresentationExport.tsx
  - src/components/b2b/forms/JourneySimulatorForm.tsx
autonomous: true

must_haves:
  truths:
    - "RM can generate journey simulation draft for a client"
    - "RM can review and modify journey narrative before submission"
    - "Compliance Officer can approve/reject journeys in formal state machine workflow"
    - "RM can view immutable version history for journeys with diffs between versions"
    - "RM can export client presentation document for a journey"
    - "RM can track post-approval journey execution status"
  artifacts:
    - path: "src/app/(b2b)/journeys/page.tsx"
      provides: "Journey management list with pipeline view and DataTable"
      min_lines: 80
    - path: "src/app/(b2b)/journeys/[id]/page.tsx"
      provides: "Journey detail with governance panel, version history, execution tracking"
      min_lines: 120
    - path: "src/components/b2b/workflows/JourneyGovernancePanel.tsx"
      provides: "State machine-driven approval/rejection panel with permission gates"
      min_lines: 80
    - path: "src/components/b2b/workflows/VersionHistory.tsx"
      provides: "Immutable version timeline with diff capability"
      min_lines: 60
    - path: "src/components/b2b/forms/JourneySimulatorForm.tsx"
      provides: "Journey generation form selecting client, category, and parameters"
      min_lines: 80
  key_links:
    - from: "src/components/b2b/workflows/JourneyGovernancePanel.tsx"
      to: "src/lib/state-machines/journey-workflow.ts"
      via: "panel uses getAvailableTransitions and executeTransition"
      pattern: "getAvailableTransitions|executeTransition"
    - from: "src/components/b2b/workflows/JourneyGovernancePanel.tsx"
      to: "src/lib/rbac/permissions.ts"
      via: "governance panel checks APPROVE permission for compliance actions"
      pattern: "useCan|hasPermission"
    - from: "src/app/(b2b)/journeys/[id]/page.tsx"
      to: "src/lib/services/mock/journey.mock.ts"
      via: "detail page fetches journey and versions from service"
      pattern: "services\\.journey"
---

<objective>
Build the Journey Governance Workflow (GOVN-01 through GOVN-06): journey list with pipeline view, journey simulation/generation, RM review and modification, compliance approval/rejection with formal state machine, immutable version history with diffs, client presentation export, and post-approval execution tracking.

Purpose: This is the core governance workflow that differentiates the B2B portal — journeys go through a formal approval pipeline (DRAFT -> RM_REVIEW -> COMPLIANCE_REVIEW -> APPROVED -> PRESENTED -> EXECUTED) with full audit trail and version control.

Output: Complete journey governance lifecycle from generation to execution tracking.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-b2b-institutional-portal/04-RESEARCH.md

Key existing files:
@src/lib/state-machines/journey-workflow.ts (from Plan 01 — state machine with transitions and permission checks)
@src/lib/services/mock/journey.mock.ts (existing MockJourneyService with version support)
@src/lib/types/entities.ts (Journey, JourneyVersion, JourneyStatus enum)
@src/lib/rbac/usePermission.ts (useCan hook)
@src/lib/utils/narrative-generator.ts (B2C narrative generator — reuse template patterns)
@src/components/b2b/tables/DataTable.tsx (from Plan 01)
@src/components/b2b/layouts/StatusBadge.tsx (from Plan 01)
@src/components/shared/Modal/index.tsx
@src/components/shared/Card/index.tsx
@src/components/shared/Button/index.tsx
@src/components/shared/Tabs/index.tsx

Prior plan SUMMARY (needed for DataTable, state machine references):
@.planning/phases/04-b2b-institutional-portal/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Journey list page and journey simulation/generation</name>
  <files>
    src/app/(b2b)/journeys/page.tsx
    src/app/(b2b)/journeys/simulate/page.tsx
    src/components/b2b/forms/JourneySimulatorForm.tsx
  </files>
  <action>
    **Step 1: Journey List Page**

    Create `src/app/(b2b)/journeys/page.tsx` as `'use client'`.

    Page structure:
    - Header: "Journey Governance" title + "Generate Journey" Button (primary, links to `/journeys/simulate`)
    - Permission gate: `can(Permission.READ, 'journey')`

    Two view modes (toggle button group):

    **Pipeline View** (default):
    - Horizontal Kanban-style pipeline showing journey cards grouped by status
    - Columns: DRAFT, RM_REVIEW, COMPLIANCE_REVIEW, APPROVED, PRESENTED, EXECUTED
    - Each column has a header with status label (using `getStateLabel` from state machine), count badge, and color indicator (using `getStateColor`)
    - Journey cards in each column show: title, client name, category badge, last updated (relative time), assigned RM name
    - Cards are clickable, navigate to `/journeys/{id}`
    - Horizontal scroll if columns overflow on smaller screens

    **Table View**:
    - DataTable with columns: Journey Title, Client, Category, Status (StatusBadge), Assigned RM, Created, Last Updated, Actions (view button)
    - Searchable by title and client name
    - Sortable by all columns

    Fetch all journeys for the institution's clients. For mock, get all journeys from localStorage (no institution filter for simplicity — filter by checking if the journey has an assignedRM matching mock RM or any RM).

    **Step 2: Journey Simulation Page**

    Create `src/app/(b2b)/journeys/simulate/page.tsx`:
    - Breadcrumb: Journey Governance / Generate Journey
    - Permission gate: `can(Permission.WRITE, 'journey')`
    - Renders `<JourneySimulatorForm />`

    **Step 3: Journey Simulator Form**

    Create `src/components/b2b/forms/JourneySimulatorForm.tsx`.

    This form allows RM to generate a journey draft for a client:

    Fields:
    1. **Select Client**: Dropdown of RM's clients (fetched from `services.client.getClientsByRM`). Shows client name + risk category badge.
    2. **Journey Category**: Select from JourneyCategory enum values (Travel, Investment, Estate Planning, etc.)
    3. **Emotional Objective** (textarea): What emotional outcome should this journey target? Pre-populate suggestion based on client's emotionalProfile if available.
    4. **Discretion Level**: Radio group (High/Medium/Standard) with descriptions.
    5. **Additional Context** (textarea, optional): Special considerations, constraints, client preferences.

    On submit:
    - Use narrative generator (reference `src/lib/utils/narrative-generator.ts` pattern from B2C) to generate a journey narrative based on the selected parameters. For B2B, adapt the templates to include more structured elements (strategic reasoning, risk summary, discretion annotation).
    - Call `services.journey.createJourney()` with status DRAFT, assignedRM set to MOCK_RM_USER_ID
    - Navigate to `/journeys/{newJourneyId}` for review
    - Toast: "Journey draft generated for {clientName}"

    Form validated with Zod. Use React Hook Form for state management (following existing patterns).
  </action>
  <verify>
    Run `npm run build`. Navigate to `/journeys`:
    - Pipeline view shows journeys grouped by status columns
    - Toggle to table view shows DataTable with sorting and search
    - Click "Generate Journey" navigates to `/journeys/simulate`
    - Fill out simulator form, submit, redirected to new journey detail page
    - Toast notification confirms generation
  </verify>
  <done>
    Journey list page shows both pipeline and table views. Journey simulator form generates draft journey with narrative for selected client. GOVN-01 (generate simulation) complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Journey detail page with governance panel, version history, diff, export, execution tracking</name>
  <files>
    src/app/(b2b)/journeys/[id]/page.tsx
    src/components/b2b/workflows/JourneyGovernancePanel.tsx
    src/components/b2b/workflows/VersionHistory.tsx
    src/components/b2b/workflows/VersionDiff.tsx
    src/components/b2b/workflows/ExecutionTracker.tsx
    src/components/b2b/workflows/PresentationExport.tsx
  </files>
  <action>
    **Step 1: Journey Detail Page**

    Create `src/app/(b2b)/journeys/[id]/page.tsx` as `'use client'`.

    Page structure:
    - Breadcrumb: Journey Governance / {Journey Title}
    - Header: Journey title (font-serif text-3xl), status badge (using getStateColor/getStateLabel), category badge, discretion level indicator
    - Two-column layout on lg (main content 2/3 + governance sidebar 1/3), single column on mobile

    **Main Content (left column):**
    - **Narrative Section**: Journey narrative text in editorial style (font-serif for body, comfortable line-height). Editable textarea when in DRAFT or RM_REVIEW status (only if `can(Permission.WRITE, 'journey')`). "Save Changes" button that calls `services.journey.updateJourney()` and creates a new JourneyVersion. Toast: "Journey updated, version {N} created".
    - **Journey Details Card**: Emotional objective, strategic reasoning, risk summary, discretion annotation — all editable in DRAFT/RM_REVIEW.
    - **Version History** component (below narrative)
    - **Execution Tracker** component (only visible when status is APPROVED, PRESENTED, or EXECUTED)

    **Governance Sidebar (right column):**
    - **JourneyGovernancePanel** component — the state machine-driven action panel
    - **Client Info Card**: Client name, risk level, emotional profile summary
    - **Presentation Export** button (only when status is APPROVED or later)

    Load journey data with `services.journey.getJourneyById(params.id)`. Load versions with `services.journey.getJourneyVersions(params.id)`.

    **Step 2: Journey Governance Panel**

    Create `src/components/b2b/workflows/JourneyGovernancePanel.tsx`.

    This is the core workflow component. Uses the state machine from Plan 01.

    Props: `{ journey: Journey; versions: JourneyVersion[]; onTransition: () => void }`

    Content:
    - Current state indicator: Large status badge with state label
    - State flow visualization: Horizontal step indicator showing all states (DRAFT -> RM_REVIEW -> COMPLIANCE_REVIEW -> APPROVED -> PRESENTED -> EXECUTED). Current state highlighted, past states checked, future states dimmed.
    - Permission-gated actions: Use `const canApprove = useCan(Permission.APPROVE, 'journey')` from usePermission hook. Use `getAvailableTransitions(journey.status, currentRole, context)` to get available actions for current user's role. For compliance-specific actions (APPROVE/REJECT at COMPLIANCE_REVIEW stage), additionally wrap action buttons in `{canApprove && ...}` to ensure UI-level permission enforcement alongside state machine validation.
    - For each available action, render a button with `getTransitionLabel(event)`:
      - "Submit for Review" (DRAFT -> RM_REVIEW): Primary button
      - "Approve" (RM_REVIEW -> COMPLIANCE_REVIEW): Primary button
      - "Request Changes" (RM_REVIEW -> DRAFT): Secondary button with textarea for reason
      - "Approve Journey" (COMPLIANCE_REVIEW -> APPROVED): Primary button (only for ComplianceOfficer)
      - "Reject Journey" (COMPLIANCE_REVIEW -> DRAFT): Destructive button with required rejection reason textarea
      - "Present to Client" (APPROVED -> PRESENTED): Primary button
      - "Begin Execution" (PRESENTED -> EXECUTED): Primary button
      - "Archive" (EXECUTED -> ARCHIVED): Secondary button
    - On action click:
      1. Call `executeTransition(journey.status, event, currentRole, context)` to validate
      2. Create new JourneyVersion via `services.journey.createJourneyVersion(journeyId, { ...versionData, status: nextState })`
      3. Update journey status via `services.journey.updateJourney(journeyId, { status: nextState })`
      4. Log audit event via `services.audit.log({ event: 'JOURNEY_TRANSITION', ... })`
      5. Toast success with transition label
      6. Call `onTransition()` to refresh parent data
    - If no available actions (e.g., ARCHIVED state or insufficient permissions), show "No actions available" message
    - Rejection/change request requires reason text (validate non-empty before proceeding)

    **Step 3: Version History**

    Create `src/components/b2b/workflows/VersionHistory.tsx`.

    Props: `{ versions: JourneyVersion[]; currentVersionId: string }`

    Content:
    - Vertical timeline of all versions, newest first
    - Each version node shows: Version number ("v{N}"), status at that version (StatusBadge), modified by, timestamp (relative), rejection reason if present
    - Current version highlighted with distinct border
    - "Compare" button on each version (except v1) that opens VersionDiff modal comparing that version to previous version

    **Step 4: Version Diff**

    Create `src/components/b2b/workflows/VersionDiff.tsx`.

    Props: `{ versionA: JourneyVersion; versionB: JourneyVersion; open: boolean; onOpenChange: (open: boolean) => void }`

    Content:
    - Modal showing side-by-side or inline diff of two versions
    - Compares: title, narrative, status
    - For narrative diff: Simple word-level visual diff — highlight added text in green background, removed text in red background with strikethrough. Use a simple diff algorithm: split by words, compare arrays, mark additions/removals.
    - Header shows "Version {A} vs Version {B}"
    - Status change shown as arrow: "DRAFT -> RM_REVIEW"
    - Keep diff simple — no need for a full diff library. Word-split comparison is sufficient for narratives.

    **Step 5: Presentation Export**

    Create `src/components/b2b/workflows/PresentationExport.tsx`.

    Props: `{ journey: Journey }`

    Content:
    - Button "Export Presentation" (only visible when journey is APPROVED or later)
    - Permission gate: `can(Permission.EXPORT, 'journey')` — NOTE: RM has WRITE but may need EXPORT. Check if RM has WRITE on journey, and treat WRITE as sufficient for export (or add EXPORT to RM permissions in the permission matrix if not present).
    - On click: Generate a formatted document (simple approach — create a printable HTML page opened in new tab using `window.open`):
      - Elan Glimmora letterhead (logo placeholder + institution name)
      - Journey title, category, discretion level
      - Full narrative text
      - Emotional objective, strategic reasoning
      - Risk summary
      - "Prepared by {RM Name} | {Date}"
      - Print-optimized CSS (hide browser chrome, use serif fonts)
    - Alternatively, generate as downloadable PDF-like format by creating a hidden printable div and triggering `window.print()`
    - Toast: "Presentation ready for export"

    **Step 6: Execution Tracker**

    Create `src/components/b2b/workflows/ExecutionTracker.tsx`.

    Props: `{ journey: Journey }`

    Only renders when journey status is APPROVED, PRESENTED, or EXECUTED.

    Content:
    - Execution timeline with milestones:
      - "Approved" (date from version that transitioned to APPROVED)
      - "Presented to Client" (date from PRESENTED version, or "Pending" if not yet)
      - "Execution Begun" (date from EXECUTED version, or "Pending")
    - Each milestone shows date, status indicator (check/pending/future)
    - If EXECUTED: Show "Journey Complete" success state with confetti-style card
    - Simple visual: vertical dotted line with circle markers, filled for completed, hollow for pending
  </action>
  <verify>
    Run `npm run build`. Navigate to `/journeys/{id}`:
    - Journey detail loads with narrative, details, governance panel
    - Governance panel shows available actions based on current status and role
    - Test state machine flow: Submit for Review -> Approve (RM) -> Approve (compliance) -> Present -> Execute
    - Each transition creates a new version (check version history updates)
    - Version history shows timeline, click "Compare" opens diff modal
    - Diff modal shows word-level differences between versions
    - "Export Presentation" opens printable document
    - Execution tracker shows milestone progression for approved journeys
    - Reject/Request Changes requires reason text
  </verify>
  <done>
    Journey detail page shows full governance workflow. State machine transitions work end-to-end with permission enforcement. Version history tracks all changes immutably with diff capability. Presentation export generates printable document. Execution tracker shows post-approval milestones. GOVN-02 through GOVN-06 complete.
  </done>
</task>

</tasks>

<verification>
- Journey list at `/journeys` shows pipeline and table views
- Journey simulation at `/journeys/simulate` generates draft journey for selected client
- Journey detail at `/journeys/{id}` shows governance panel with state machine actions
- Full state machine flow works: DRAFT -> RM_REVIEW -> COMPLIANCE_REVIEW -> APPROVED -> PRESENTED -> EXECUTED
- Each transition creates new JourneyVersion (immutable history)
- Version diff shows word-level changes between versions
- Presentation export generates formatted printable document
- Execution tracker shows milestone progression
- Permission checks: only ComplianceOfficer can approve at COMPLIANCE_REVIEW stage
- Rejection requires reason text, rejection reason visible in version history
</verification>

<success_criteria>
All 6 GOVN requirements met: GOVN-01 (generate simulation), GOVN-02 (RM review/modification), GOVN-03 (compliance approval flow with full state machine), GOVN-04 (version control with diffs), GOVN-05 (client presentation export), GOVN-06 (execution status tracking). State machine enforces valid transitions with RBAC permission gates.
</success_criteria>

<output>
After completion, create `.planning/phases/04-b2b-institutional-portal/04-03-SUMMARY.md`
</output>
