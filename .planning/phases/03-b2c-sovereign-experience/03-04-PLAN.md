---
phase: 03-b2c-sovereign-experience
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(b2c)/vault/page.tsx
  - src/app/(b2c)/vault/[id]/page.tsx
  - src/app/(b2c)/vault/new/page.tsx
  - src/components/b2c/vault/MemoryTimeline.tsx
  - src/components/b2c/vault/TimelineItem.tsx
  - src/components/b2c/vault/MemoryForm.tsx
  - src/components/b2c/vault/MemoryDetail.tsx
  - src/components/b2c/vault/EmotionalTagFilter.tsx
  - src/components/b2c/vault/FamilySharingPanel.tsx
  - src/components/b2c/vault/MemoryActions.tsx
autonomous: true

must_haves:
  truths:
    - "UHNI can view memory vault timeline chronologically with emotional tags and milestone markers"
    - "UHNI can create, edit, lock, and export memory entries"
    - "UHNI can configure family sharing permissions per entry (spouse/heir visibility)"
    - "UHNI can erase memory entries permanently with confirmation and cascade deletion"
  artifacts:
    - path: "src/app/(b2c)/vault/page.tsx"
      provides: "Memory vault timeline page"
      min_lines: 40
    - path: "src/components/b2c/vault/MemoryTimeline.tsx"
      provides: "Chronological timeline with emotional tags"
      min_lines: 50
    - path: "src/components/b2c/vault/MemoryForm.tsx"
      provides: "Create/edit memory form"
      min_lines: 60
    - path: "src/components/b2c/vault/FamilySharingPanel.tsx"
      provides: "Family sharing permission controls"
      min_lines: 30
  key_links:
    - from: "src/components/b2c/vault/MemoryTimeline.tsx"
      to: "src/lib/services/mock/memory.mock.ts"
      via: "useServices().memory.getMemories"
      pattern: "getMemories"
    - from: "src/components/b2c/vault/MemoryForm.tsx"
      to: "src/lib/services/mock/memory.mock.ts"
      via: "createMemory / updateMemory"
      pattern: "createMemory|updateMemory"
    - from: "src/components/b2c/vault/MemoryActions.tsx"
      to: "src/lib/services/mock/memory.mock.ts"
      via: "lockMemory / deleteMemory"
      pattern: "lockMemory|deleteMemory"
---

<objective>
Build the Memory Vault -- a chronological timeline of the UHNI's memories with emotional tags, milestone markers, full CRUD flows, family sharing permissions, lock/export functionality, and permanent erase with cascade deletion.

Purpose: The Memory Vault is the UHNI's private repository of experiences. It must feel like a personal journal or memoir, not a file manager. Emotional context matters more than metadata.
Output: Working /vault timeline page, /vault/new creation page, /vault/[id] detail page with all CRUD + sharing + lock/export/erase flows.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-b2c-sovereign-experience/03-RESEARCH.md
@.planning/phases/03-b2c-sovereign-experience/03-01-SUMMARY.md

@src/lib/types/entities.ts
@src/lib/types/validation.ts
@src/lib/services/mock/memory.mock.ts
@src/lib/services/interfaces/IMemoryService.ts
@src/app/(b2c)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Memory Vault timeline with emotional tags, milestone markers, and create/edit flows</name>
  <files>
    src/app/(b2c)/vault/page.tsx
    src/app/(b2c)/vault/new/page.tsx
    src/components/b2c/vault/MemoryTimeline.tsx
    src/components/b2c/vault/TimelineItem.tsx
    src/components/b2c/vault/EmotionalTagFilter.tsx
    src/components/b2c/vault/MemoryForm.tsx
  </files>
  <action>
    1. **EmotionalTagFilter.tsx** (VALT-02): Filter bar for emotional tags:
       - Predefined emotional taxonomy: Joy, Growth, Peace, Connection, Achievement, Gratitude, Wonder, Renewal, Legacy, Love (from research)
       - Pill-shaped buttons that toggle on/off (rose when active, sand when inactive)
       - Multi-select: filter timeline to show only memories with selected tags
       - "Clear all" button to reset filters

    2. **TimelineItem.tsx**: Individual memory in the timeline:
       - Date marker on the left (vertical line with dot)
       - Milestone marker: larger dot + star icon for milestone entries (VALT-03)
       - Title (serif), description excerpt, type icon (Document/Photo/Video/Note/Audio)
       - Emotional tags displayed as small colored pills below the title
       - Lock icon if entry is locked (VALT-05)
       - Shared icon if entry has sharing permissions set
       - Click navigates to /vault/[id]
       - Framer Motion staggered entrance animation (slide in from left with opacity)

    3. **MemoryTimeline.tsx** (VALT-01): Chronological vertical timeline:
       - Fetches memories from service, sorts by createdAt descending
       - Renders TimelineItem for each memory
       - Vertical line connecting items (border-l-2 border-rose-200)
       - Groups by month/year with section headers ("February 2026", "January 2026")
       - Integrates EmotionalTagFilter at top
       - Loading state with react-loading-skeleton
       - Empty state: "Your vault is empty. Begin capturing your memories." with CTA to /vault/new

    4. **MemoryForm.tsx** (VALT-08, VALT-09): Create/edit form:
       - Use React Hook Form with Zod validation (extend CreateMemorySchema with emotional tags and milestone)
       - Fields: title (text), description (textarea), type (select from MemoryType enum), emotional tags (multi-select from predefined taxonomy, max 5), isMilestone (checkbox), file upload area (react-dropzone for photo/document attachment -- store as mock URL for now)
       - For edit mode: pre-populate from existing memory
       - "Save Memory" calls createMemory or updateMemory
       - Redirect to /vault/[id] after save
       - Luxury form styling: generous spacing, serif labels, sand backgrounds

    5. **Vault page.tsx**: Main vault page:
       - Hero: "Your Memory Vault" with narrative subtitle about preserving moments
       - "Create Memory" CTA button (links to /vault/new)
       - MemoryTimeline below hero
       - Framer Motion page entrance

    6. **Vault new page.tsx**: Create memory page:
       - Back link to /vault
       - MemoryForm in create mode
       - "Save Memory" creates entry and redirects to vault

    DESIGN: The timeline should feel like a memoir or scrapbook -- vertical progression through time with emotional context. Not a data table or file list.

    AVOID: Don't render all 500+ items at once if the list is large (research warns about this). For v1, pagination is fine (load 20 at a time with "Load more" button). Don't use free-text tag input -- predefined taxonomy only (per research pitfall #6).
  </action>
  <verify>
    `npm run build` succeeds. Navigate to /vault:
    - Empty state shown if no memories
    - "Create Memory" navigates to /vault/new
    - Creating a memory with title, description, tags saves and redirects
    - Timeline shows memories chronologically with emotional tag pills
    - Milestone entries have special marker
    - Emotional tag filter works (clicking tag filters timeline)
    - Loading skeleton shown during fetch
  </verify>
  <done>
    Memory vault timeline displays chronologically with emotional tags (VALT-01, VALT-02) and milestone markers (VALT-03). Create memory flow works end-to-end (VALT-08). Edit memory flow works (VALT-09). Emotional tag filter narrows timeline. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build memory detail page with lock, export, erase, and family sharing</name>
  <files>
    src/app/(b2c)/vault/[id]/page.tsx
    src/components/b2c/vault/MemoryDetail.tsx
    src/components/b2c/vault/MemoryActions.tsx
    src/components/b2c/vault/FamilySharingPanel.tsx
  </files>
  <action>
    1. **MemoryDetail.tsx**: Full memory view:
       - Title (serif, large), type badge, date created
       - Description in editorial typography
       - Emotional tags as styled pills
       - Milestone badge if applicable
       - Linked journeys (show as clickable links to /journeys/[id])
       - File attachment preview (if photo: image preview; if document: file icon with name)
       - Lock status indicator
       - Sharing status indicator

    2. **MemoryActions.tsx**: Action panel for memory:
       - **Edit** (VALT-09): navigates to /vault/new?edit=[id] (reuse MemoryForm in edit mode)
       - **Lock/Unlock** (VALT-05):
         - Lock: opens dialog asking for unlock condition (text input, e.g., "Family meeting March 2026"), calls `services.memory.lockMemory(id, condition)`. Locked memories cannot be edited.
         - Unlock: shows unlock condition, confirms "Are you sure you want to unlock this memory?", calls `services.memory.updateMemory(id, { isLocked: false, unlockCondition: undefined })`
       - **Export** (VALT-06):
         - Generates a JSON download of the memory entry
         - Also generates a human-readable text format (title, description, tags, dates)
         - Triggers browser download via Blob + URL.createObjectURL
       - **Erase Permanently** (VALT-07):
         - Opens confirmation modal with strong warning: "This action cannot be undone. This memory and all associated data will be permanently deleted."
         - Requires typing "ERASE" to confirm (prevents accidental deletion)
         - On confirm: calls `services.memory.deleteMemory(id)`
         - Also cascade-deletes: remove this memory ID from any journey's linkedJourneys array (query journeys, update those referencing this memory)
         - Redirect to /vault with toast "Memory permanently erased"

    3. **FamilySharingPanel.tsx** (VALT-04): Family sharing permissions:
       - Section in memory detail showing "Family Sharing"
       - Toggle: "Share with Spouse" (adds 'Spouse' to sharingPermissions array)
       - Toggle: "Share with Legacy Heir" (adds 'LegacyHeir' to sharingPermissions array)
       - Plain language explanation: "Shared entries will be visible to your [role] with view-only access"
       - Each toggle calls `services.memory.updateMemory(id, { sharingPermissions: [...] })`
       - Show current sharing status (who can see this entry)
       - If memory is locked: sharing cannot be changed (show disabled state with explanation)

    4. **Vault [id] page.tsx**: Memory detail page:
       - Fetch memory by ID from service
       - Show MemoryDetail, FamilySharingPanel, MemoryActions
       - Back link to /vault
       - 404 handling if memory not found
       - Framer Motion entrance animation

    EVERY CTA works end-to-end. Lock, export, erase, share -- all functional.

    AVOID: Don't skip the "type ERASE" confirmation -- permanent deletion needs friction. Don't allow editing locked memories -- show a clear message why edit is disabled. Don't forget cascade deletion (removing memory reference from journeys).
  </action>
  <verify>
    `npm run build` succeeds. Navigate to /vault/[id]:
    - Memory detail displays all fields
    - Edit navigates to form with pre-populated data
    - Lock: dialog asks for condition, locks memory, shows lock indicator
    - Unlock: confirms and unlocks
    - Export: downloads JSON file
    - Erase: requires typing "ERASE", deletes memory, cascade removes from journeys, redirects
    - Family sharing: spouse/heir toggles update sharingPermissions
    - Locked memories show disabled edit and sharing controls
  </verify>
  <done>
    Memory detail page with full CRUD flows. Lock with condition and unlock flow (VALT-05). Export as JSON download (VALT-06). Permanent erase with "ERASE" confirmation and cascade deletion (VALT-07). Family sharing toggles for spouse/heir visibility (VALT-04). All CTAs work end-to-end. Build passes.
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- /vault: timeline with emotional tags, milestone markers, create flow
- /vault/new: create memory form with all fields
- /vault/[id]: detail with lock/export/erase/share actions
- Erase cascade: deletes memory and removes references from journeys
- Family sharing: toggles update permissions per entry
- All VALT requirements (01-09) addressed
</verification>

<success_criteria>
1. UHNI can view memory vault timeline chronologically with emotional tags and milestone markers (Success Criteria #12)
2. UHNI can create, edit, lock, and export memory entries (Success Criteria #13)
3. UHNI can configure family sharing permissions (Success Criteria #14)
4. UHNI can erase memory entries permanently with confirmation and cascade deletion (Success Criteria #15)
</success_criteria>

<output>
After completion, create `.planning/phases/03-b2c-sovereign-experience/03-04-SUMMARY.md`
</output>
