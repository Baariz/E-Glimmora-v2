---
phase: 04-b2b-institutional-portal
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(b2b)/risk/page.tsx
  - src/app/(b2b)/risk/[country]/page.tsx
  - src/components/b2b/risk/GeopoliticalMap.tsx
  - src/components/b2b/risk/TravelAdvisoryList.tsx
  - src/components/b2b/risk/ExposureAnalytics.tsx
  - src/components/b2b/risk/InsuranceLogs.tsx
  - src/components/b2b/risk/ComplianceFlags.tsx
  - src/app/(b2b)/access/page.tsx
  - src/components/b2b/access/PrivilegeTierConfig.tsx
  - src/components/b2b/access/RBACManager.tsx
  - src/components/b2b/access/ApprovalRouting.tsx
  - src/components/b2b/access/RegistryLogs.tsx
  - src/app/(b2b)/vault/page.tsx
  - src/components/b2b/vault/GovernedVault.tsx
  - src/components/b2b/vault/VaultReportExport.tsx
  - src/components/b2b/vault/RetentionPolicyManager.tsx
autonomous: true

must_haves:
  truths:
    - "RM can view geopolitical risk map with country-level risk indicators"
    - "RM can view travel advisories per region"
    - "Compliance Officer can view exposure risk analytics and flag compliance issues"
    - "RM can document insurance logs for clients"
    - "Institutional Admin can assign privilege tiers and configure role permissions"
    - "Institutional Admin can manage multi-role RBAC assignments"
    - "Institutional Admin can configure approval routing chains"
    - "Institutional Admin can view access registry logs and audit trail"
    - "RM can view governed memory vault with shared visibility between RM and client"
    - "RM can export memory vault reports with audit tracking"
    - "Institutional Admin can configure retention policy management"
  artifacts:
    - path: "src/app/(b2b)/risk/page.tsx"
      provides: "Risk Intelligence hub with map, advisories, analytics, insurance, flags"
      min_lines: 80
    - path: "src/app/(b2b)/access/page.tsx"
      provides: "Access Engineering hub with RBAC management, approval routing, audit"
      min_lines: 60
    - path: "src/app/(b2b)/vault/page.tsx"
      provides: "Governed Memory Vault with shared view, export, retention policies"
      min_lines: 60
    - path: "src/components/b2b/risk/GeopoliticalMap.tsx"
      provides: "Visual risk map display using colored region cards"
      min_lines: 50
    - path: "src/components/b2b/access/RBACManager.tsx"
      provides: "Multi-role RBAC assignment interface for institutional users"
      min_lines: 80
  key_links:
    - from: "src/app/(b2b)/risk/page.tsx"
      to: "src/lib/services/mock/risk.mock.ts"
      via: "risk page fetches risk records and geopolitical data"
      pattern: "services\\.risk"
    - from: "src/components/b2b/access/RBACManager.tsx"
      to: "src/lib/rbac/permissions.ts"
      via: "RBAC manager reads permission matrices for display"
      pattern: "getPermissionMatrix|B2B_PERMISSIONS"
    - from: "src/app/(b2b)/vault/page.tsx"
      to: "src/lib/services/mock/memory.mock.ts"
      via: "governed vault fetches client memories via memory service"
      pattern: "services\\.memory"
---

<objective>
Build Risk Intelligence (RISK-01 through RISK-05), Access Engineering (ACCS-01 through ACCS-05), and Governed Memory Vault (GVLT-01 through GVLT-04) — three operational modules that round out the B2B portal's risk management, permission administration, and governed data access capabilities.

Purpose: These three modules serve different B2B personas — Risk Intelligence for RMs and Compliance Officers, Access Engineering for Institutional Admins, and Governed Vault for RMs working with client data under governance rules.

Output: Three complete B2B sections with full CRUD flows and permission gating.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-b2b-institutional-portal/04-RESEARCH.md

Key existing files:
@src/lib/services/mock/risk.mock.ts (from Plan 01 — MockRiskService)
@src/lib/services/mock/audit.mock.ts (from Plan 01 — MockAuditService)
@src/lib/services/mock/memory.mock.ts (existing MockMemoryService from Phase 3)
@src/lib/types/entities.ts (RiskRecord, GeopoliticalRisk, TravelAdvisory, InsuranceLog, RetentionPolicy, MemoryItem types)
@src/lib/rbac/permissions.ts (B2B permission matrices — InstitutionalAdmin has CONFIGURE on institution, privacy)
@src/lib/rbac/usePermission.ts (useCan hook)
@src/components/b2b/tables/DataTable.tsx (from Plan 01)
@src/components/b2b/layouts/StatsRow.tsx (from Plan 01)
@src/components/b2b/layouts/StatusBadge.tsx (from Plan 01)
@src/components/shared/Card/index.tsx
@src/components/shared/Modal/index.tsx
@src/components/shared/Tabs/index.tsx

Prior plan SUMMARY:
@.planning/phases/04-b2b-institutional-portal/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Risk Intelligence section (geopolitical map, advisories, analytics, insurance, compliance flags)</name>
  <files>
    src/app/(b2b)/risk/page.tsx
    src/app/(b2b)/risk/[country]/page.tsx
    src/components/b2b/risk/GeopoliticalMap.tsx
    src/components/b2b/risk/TravelAdvisoryList.tsx
    src/components/b2b/risk/ExposureAnalytics.tsx
    src/components/b2b/risk/InsuranceLogs.tsx
    src/components/b2b/risk/ComplianceFlags.tsx
  </files>
  <action>
    **Step 1: Seed mock geopolitical and advisory data**

    Before building UI, ensure the MockRiskService (from Plan 01) has methods for geopolitical data. If not already present, extend `src/lib/services/mock/risk.mock.ts` to add:
    - `getGeopoliticalRisks(): Promise<GeopoliticalRisk[]>` — returns seeded list of 12-15 countries/regions with risk levels
    - `getTravelAdvisories(): Promise<TravelAdvisory[]>` — returns 8-10 travel advisories
    - `getInsuranceLogs(clientId: string): Promise<InsuranceLog[]>` — returns insurance records for a client
    - `createInsuranceLog(data: Partial<InsuranceLog>): Promise<InsuranceLog>` — creates new insurance log
    - `flagComplianceIssue(clientId: string, flag: string): Promise<void>` — adds compliance flag to client risk record

    Also extend `src/lib/services/interfaces/IRiskService.ts` if needed to include these methods.

    Seed data: Include realistic regions — Switzerland (Low), UAE (Low), Nigeria (High), Russia (Critical), Brazil (Moderate), Japan (Low), Mexico (Elevated), UK (Low), Monaco (Low), Turkey (Moderate), Colombia (High), Singapore (Low). Advisories for the elevated/high/critical countries.

    Insurance log seeds: 4-5 records across different clients (Travel Insurance, Health Coverage, Property Insurance, etc.)

    **Step 2: Risk Intelligence Page**

    Create `src/app/(b2b)/risk/page.tsx` as `'use client'`.

    Page structure:
    - Header: "Risk Intelligence" title + subtitle
    - Permission gate: `can(Permission.READ, 'risk')`
    - Tabbed interface with 5 tabs:

    **Tab 1: Geopolitical Map** (default)
    - Renders `<GeopoliticalMap />` component
    - Below map: DataTable of all regions with columns: Region, Country, Threat Level (StatusBadge with threat color map), Risk Factors (comma-separated), Last Updated

    **Tab 2: Travel Advisories**
    - Renders `<TravelAdvisoryList />`

    **Tab 3: Exposure Analytics**
    - Renders `<ExposureAnalytics />`

    **Tab 4: Insurance Logs**
    - Renders `<InsuranceLogs />`

    **Tab 5: Compliance Flags** (only visible if `can(Permission.APPROVE, 'journey')` or `can(Permission.READ, 'audit')` — for Compliance Officers)
    - Renders `<ComplianceFlags />`

    **Step 3: GeopoliticalMap component**

    Create `src/components/b2b/risk/GeopoliticalMap.tsx`.

    Since we cannot render an actual interactive map without a mapping library (and that would be over-engineering for v1), use a **region card grid** approach:
    - Grid of country/region cards (grid-cols-2 md:grid-cols-3 lg:grid-cols-4)
    - Each card shows: Country flag emoji (use a simple mapping), country name, threat level badge (color-coded: Low=olive, Moderate=gold, Elevated=amber, High=rose, Critical=red), number of risk factors
    - Cards with High/Critical threat level have a subtle red border/glow
    - Click on a card navigates to `/risk/{country}` for detail view
    - Filter bar at top: filter by threat level (show all / Low / Moderate / Elevated / High / Critical)

    **Step 4: Country Risk Detail Page**

    Create `src/app/(b2b)/risk/[country]/page.tsx`:
    - Shows detailed risk information for a specific country
    - Risk factors list (bullet points)
    - Travel advisories for this country
    - Clients with journeys in this region (cross-reference with journey data)
    - Back button to risk overview

    **Step 5: TravelAdvisoryList component**

    Create `src/components/b2b/risk/TravelAdvisoryList.tsx`:
    - DataTable of travel advisories: Country, Region, Advisory Level (StatusBadge), Summary (truncated), Effective Date, Expires
    - Expandable rows (click to see full summary text)
    - Filter by advisory level

    **Step 6: ExposureAnalytics component**

    Create `src/components/b2b/risk/ExposureAnalytics.tsx`:
    - Aggregated risk view across the RM's client portfolio
    - Recharts PieChart showing distribution of client risk categories (Low/Medium/High/Critical)
    - Recharts BarChart showing top 5 risk factors across all clients (most common flags)
    - Stats: Average portfolio risk score, highest risk client, clients needing review (nextReviewDate < today)
    - DataTable of clients sorted by risk score (highest first) with columns: Client, Risk Score, Risk Category, Flags, Next Review Date

    **Step 7: InsuranceLogs component**

    Create `src/components/b2b/risk/InsuranceLogs.tsx`:
    - DataTable of insurance records: Client Name, Type, Provider, Policy Number, Coverage, Valid From, Valid Until, Notes
    - "Add Insurance Log" button opens modal form (React Hook Form + Zod) with fields: select client, type (dropdown), provider, policy number, coverage description, valid dates, notes
    - On submit: `services.risk.createInsuranceLog(data)` + toast success
    - Permission gate: `can(Permission.WRITE, 'risk')` for add button

    **Step 8: ComplianceFlags component**

    Create `src/components/b2b/risk/ComplianceFlags.tsx`:
    - List of flagged compliance issues across portfolio
    - Each flag shows: Client name, flag type, severity, flagged by, date
    - "Flag Issue" button opens modal: select client, describe issue, select severity
    - On submit: adds flag to client's risk record + audit log entry
    - Only visible to ComplianceOfficer role (permission gated in parent)
  </action>
  <verify>
    Run `npm run build`. Navigate to `/risk`:
    - Geopolitical map tab shows country/region cards with threat levels
    - Click country card navigates to detail page
    - Travel Advisories tab shows DataTable of advisories
    - Exposure Analytics tab shows pie chart + bar chart + risk table
    - Insurance Logs tab shows records, "Add" button opens form, can create new log
    - Compliance Flags tab shows flagged issues (only for compliance role)
  </verify>
  <done>
    Risk Intelligence section complete with 5 tabs. Geopolitical map shows country risk levels. Travel advisories displayed. Exposure analytics shows portfolio risk distribution. Insurance logs support CRUD. Compliance flags allow issue reporting. RISK-01 through RISK-05 complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Access Engineering and Governed Memory Vault sections</name>
  <files>
    src/app/(b2b)/access/page.tsx
    src/components/b2b/access/PrivilegeTierConfig.tsx
    src/components/b2b/access/RBACManager.tsx
    src/components/b2b/access/ApprovalRouting.tsx
    src/components/b2b/access/RegistryLogs.tsx
    src/app/(b2b)/vault/page.tsx
    src/components/b2b/vault/GovernedVault.tsx
    src/components/b2b/vault/VaultReportExport.tsx
    src/components/b2b/vault/RetentionPolicyManager.tsx
  </files>
  <action>
    **ACCESS ENGINEERING SECTION**

    **Step 1: Access Engineering Page**

    Create `src/app/(b2b)/access/page.tsx` as `'use client'`.

    Page structure:
    - Header: "Access Engineering" title
    - Permission gate: `can(Permission.CONFIGURE, 'institution')` for config tabs; `can(Permission.READ, 'audit')` for logs tab
    - Tabbed interface with 4 tabs:

    **Tab 1: Privilege Tiers** (ACCS-01)
    - Renders `<PrivilegeTierConfig />`

    **Tab 2: Role Management** (ACCS-02)
    - Renders `<RBACManager />`

    **Tab 3: Approval Routing** (ACCS-03)
    - Renders `<ApprovalRouting />`

    **Tab 4: Access Logs** (ACCS-04 + ACCS-05)
    - Renders `<RegistryLogs />`

    **Step 2: PrivilegeTierConfig component**

    Create `src/components/b2b/access/PrivilegeTierConfig.tsx`.

    Shows the institution's privilege tier configuration:
    - List of B2B roles (from B2BRole enum): RelationshipManager, PrivateBanker, FamilyOfficeDirector, ComplianceOfficer, InstitutionalAdmin, UHNIPortal
    - For each role, show a card with:
      - Role name and description
      - Current permissions grid: Resources as rows, Permission types as columns (READ, WRITE, DELETE, APPROVE, EXPORT, ASSIGN, CONFIGURE). Checkmarks where permission exists.
      - Read from `getPermissionMatrix('b2b')` to populate the grid
    - "Edit Permissions" button (for InstitutionalAdmin only) that opens a modal where checkboxes can be toggled
    - NOTE: For v1 mock, permission changes are visual only (stored in localStorage as overrides) — the actual RBAC engine still uses the hardcoded matrices. Show a note: "Custom permissions apply to this institution only."
    - On save: Store custom permission overrides in localStorage under `'institution_permission_overrides'`, toast success

    **Step 3: RBACManager component**

    Create `src/components/b2b/access/RBACManager.tsx`.

    Multi-role RBAC assignment interface:
    - DataTable of institutional users (fetch from `services.user` — filter users with B2B roles and matching institutionId)
    - Columns: Name, Email, Current Role (StatusBadge), Assigned Since, Last Login, Actions
    - "Assign Role" action per user: Opens modal with role selector (dropdown of B2BRole values), confirmation dialog
    - "Add User" button: Opens modal to invite/assign a new institutional user (select role, enter email)
    - On role change: Update user via `services.user` + audit log entry + toast
    - Permission gate: `can(Permission.ASSIGN, 'user')` for assign actions

    Seed mock institutional users (5-6 users with different B2B roles) in the MockUserService if not already present. Add a method `getUsersByInstitution(institutionId: string)` to the user service.

    **Step 4: ApprovalRouting component**

    Create `src/components/b2b/access/ApprovalRouting.tsx`.

    Configure approval chain workflows:
    - Visual flow diagram showing the journey approval chain: DRAFT -> RM_REVIEW -> COMPLIANCE_REVIEW -> APPROVED
    - Each node shows: which role is the approver, what permissions are required
    - "Configure" button opens modal where admin can:
      - Toggle whether compliance review is required (some institutions may skip it)
      - Set minimum number of approvers per stage
      - Configure auto-escalation timeout (days until escalation)
    - Store configuration in localStorage under `'approval_routing_config'`
    - For v1: Visual configuration that shows intent but doesn't dynamically modify the actual state machine. Note: "Routing changes apply to future journeys."
    - Toast on save

    **Step 5: RegistryLogs component**

    Create `src/components/b2b/access/RegistryLogs.tsx`.

    Comprehensive audit trail viewer:
    - DataTable of audit events from `services.audit.getByContext('b2b')`
    - Columns: Timestamp (formatted), User, Action (StatusBadge), Resource Type, Resource ID, Event Description
    - Filters: Date range picker (simple from/to inputs), action type filter (CREATE/READ/UPDATE/DELETE/APPROVE), resource type filter, user filter
    - Search by event description
    - Pagination (default 25 per page)
    - "Export Logs" button: Generates CSV file of filtered audit events. Use simple CSV generation (escape commas, handle newlines). Trigger download via `Blob` + `URL.createObjectURL` + click on hidden anchor. Toast: "Audit log exported"
    - Permission gate: `can(Permission.EXPORT, 'audit')` for export button

    ---

    **GOVERNED MEMORY VAULT SECTION**

    **Step 6: Governed Vault Page**

    Create `src/app/(b2b)/vault/page.tsx` as `'use client'`.

    Page structure:
    - Header: "Memory Vault (Governed)" title + subtitle explaining governed access
    - Permission gate: `can(Permission.READ, 'vault')`
    - Two sections:

    **Client Selector** (top): Dropdown to select which client's vault to view. RM selects a client from their assigned clients list. Shows client name + status.

    **Vault Content** (below selector): Renders `<GovernedVault />` for selected client.

    **Tab interface** within vault:
    - **Vault Entries** (default): GovernedVault component
    - **Reports**: VaultReportExport component
    - **Retention Policies**: RetentionPolicyManager (only visible for InstitutionalAdmin)

    **Step 7: GovernedVault component**

    Create `src/components/b2b/vault/GovernedVault.tsx`.

    Props: `{ clientId: string; clientName: string }`

    Shows the client's memory vault entries in governed mode (RM has READ-only access per RBAC):
    - Timeline view of memory items (similar to B2C vault but read-only)
    - Each entry shows: title, type badge, emotional tags, date, description preview
    - Locked entries show lock icon with "Locked by client" label — RM cannot unlock
    - Entries respect sharing permissions — only show entries where sharing includes the RM's institution or the RM is explicitly allowed
    - Click on entry opens detail modal (read-only view — no edit, no delete buttons)
    - Govenance banner at top: "You are viewing {clientName}'s vault in governed mode. Modifications require client consent."
    - All vault access logged to audit: When RM views a vault entry, call `services.audit.log({ event: 'VAULT_ACCESS', resourceType: 'vault', action: 'READ', ... })`
    - Fetch memories with `services.memory.getMemories(clientId)` (filter by sharing permissions client-side)

    **Step 8: VaultReportExport component**

    Create `src/components/b2b/vault/VaultReportExport.tsx`.

    Props: `{ clientId: string; clientName: string }`

    Export memory vault data as a report:
    - Report format options: "Summary Report" (overview + counts + tags), "Full Export" (all entry details)
    - Date range filter for entries to include
    - "Generate Report" button:
      - Collects vault entries within date range
      - Generates formatted HTML report (similar to journey presentation export pattern):
        - Header: "Memory Vault Report — {clientName}"
        - Institution name, RM name, date generated
        - Summary: total entries, entries by type, top emotional tags
        - Entry list: title, type, date, description, tags
        - Footer: "Report generated under governed access. All access logged."
      - Opens in new tab for printing/saving
    - Log report generation to audit trail
    - Toast: "Vault report generated"

    **Step 9: RetentionPolicyManager component**

    Create `src/components/b2b/vault/RetentionPolicyManager.tsx`.

    Only visible to InstitutionalAdmin (`can(Permission.CONFIGURE, 'privacy')`).

    Content:
    - DataTable of current retention policies for the institution
    - Columns: Entity Type (e.g., "Memory Entries", "Journey Versions", "Audit Logs"), Retention Period (days), Auto-Archive, Auto-Delete, Last Modified
    - "Add Policy" button: Modal form to create new retention policy (entity type dropdown, retention days input, auto-archive toggle, auto-delete toggle)
    - Edit action per row: Opens edit modal
    - Store policies in localStorage under `'retention_policies'`
    - On save/create: toast success + audit log entry
    - Warning banner: "Retention policies affect data lifecycle. Auto-delete is irreversible."
  </action>
  <verify>
    Run `npm run build`. Navigate to:
    - `/risk`: 5 tabs render (map, advisories, analytics, insurance, flags). All CRUD flows work.
    - `/access`: 4 tabs render (privilege tiers, RBAC, routing, logs). Permission grid displays correctly. Audit log export downloads CSV.
    - `/vault`: Client selector works, governed vault shows read-only memory entries, report export generates HTML document, retention policies configurable.
  </verify>
  <done>
    Risk Intelligence (5 requirements), Access Engineering (5 requirements), and Governed Memory Vault (4 requirements) sections complete. All 14 requirements (RISK-01 through RISK-05, ACCS-01 through ACCS-05, GVLT-01 through GVLT-04) delivered with RBAC permission gating, audit logging, and end-to-end flows.
  </done>
</task>

</tasks>

<verification>
- Risk Intelligence at `/risk` shows geopolitical map, travel advisories, exposure analytics, insurance logs, compliance flags
- Country detail page at `/risk/{country}` shows detailed risk information
- Insurance logs support create flow (modal form -> save -> toast)
- Compliance flags allow issue reporting for ComplianceOfficer
- Access Engineering at `/access` shows privilege tier grid, RBAC user management, approval routing config, audit logs
- Audit log export downloads CSV file
- RBAC manager shows institutional users with role assignment capabilities
- Governed Vault at `/vault` shows read-only client memories with governed access banner
- Vault report export generates HTML document for printing
- Retention policy manager allows CRUD for data retention rules
- All pages permission-gated per B2B role matrices
</verification>

<success_criteria>
14 requirements completed: RISK-01 through RISK-05 (risk intelligence), ACCS-01 through ACCS-05 (access engineering), GVLT-01 through GVLT-04 (governed vault). Every CTA has end-to-end flow. All sections enforce RBAC permissions. Audit logging integrated for sensitive operations.
</success_criteria>

<output>
After completion, create `.planning/phases/04-b2b-institutional-portal/04-04-SUMMARY.md`
</output>
