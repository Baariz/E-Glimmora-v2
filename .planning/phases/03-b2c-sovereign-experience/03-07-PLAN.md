---
phase: 03-b2c-sovereign-experience
plan: 07
type: execute
wave: 4
depends_on: ["03-04", "03-05", "03-06"]
files_modified:
  - src/components/b2c/privacy/GlobalEraseFlow.tsx
  - src/app/(b2c)/privacy/page.tsx
  - src/components/b2c/roles/SpouseView.tsx
  - src/components/b2c/roles/LegacyHeirView.tsx
  - src/components/b2c/roles/AdvisorView.tsx
  - src/app/(b2c)/layout.tsx
  - src/lib/rbac/b2c-role-filters.ts
autonomous: false

must_haves:
  truths:
    - "UHNI can trigger global erase with complete data deletion, cascade across all entities, confirmation dialog, and logout"
    - "Spouse role sees restricted partial access per UHNI configuration"
    - "Legacy Heir role sees view-only access to shared memories and selected journeys"
    - "Elan Advisor role sees contextual collaboration with journey thread visibility and limited intel"
  artifacts:
    - path: "src/components/b2c/privacy/GlobalEraseFlow.tsx"
      provides: "Global erase with cascade deletion and logout"
      min_lines: 50
    - path: "src/lib/rbac/b2c-role-filters.ts"
      provides: "B2C role-based data filtering functions"
      min_lines: 60
    - path: "src/components/b2c/roles/SpouseView.tsx"
      provides: "Spouse-specific restricted view"
      min_lines: 40
    - path: "src/components/b2c/roles/LegacyHeirView.tsx"
      provides: "Legacy Heir view-only experience"
      min_lines: 40
    - path: "src/components/b2c/roles/AdvisorView.tsx"
      provides: "Advisor contextual collaboration view"
      min_lines: 50
  key_links:
    - from: "src/components/b2c/privacy/GlobalEraseFlow.tsx"
      to: "src/lib/services/mock/privacy.mock.ts"
      via: "executeGlobalErase"
      pattern: "executeGlobalErase"
    - from: "src/lib/rbac/b2c-role-filters.ts"
      to: "src/lib/rbac/permissions.ts"
      via: "hasPermission checks"
      pattern: "hasPermission.*B2CRole"
    - from: "src/app/(b2c)/layout.tsx"
      to: "src/lib/rbac/b2c-role-filters.ts"
      via: "role-based layout switching"
      pattern: "B2CRole|currentRole|SpouseView|LegacyHeirView|AdvisorView"
---

<objective>
Build the Global Erase action (complete data deletion with cascade and logout) and implement B2C role enforcement -- restricted views for Spouse, Legacy Heir, and Elan Advisor roles that filter data per UHNI's privacy configuration.

Purpose: Global erase is the ultimate privacy sovereign action. Role enforcement ensures the B2C experience adapts per role -- spouse sees only what UHNI shares, heir sees view-only memories, advisor sees collaboration context only. This completes the B2C privacy story.
Output: Working global erase flow, role-filtered views for all 4 B2C roles, updated B2C layout with role detection.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-b2c-sovereign-experience/03-RESEARCH.md
@.planning/phases/03-b2c-sovereign-experience/03-01-SUMMARY.md
@.planning/phases/03-b2c-sovereign-experience/03-06-SUMMARY.md

@src/lib/types/entities.ts
@src/lib/types/roles.ts
@src/lib/rbac/permissions.ts
@src/lib/rbac/RequirePermission.tsx
@src/lib/rbac/usePermission.ts
@src/lib/services/interfaces/IPrivacyService.ts
@src/app/(b2c)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Global Erase flow with cascade deletion and B2C role data filters</name>
  <files>
    src/components/b2c/privacy/GlobalEraseFlow.tsx
    src/app/(b2c)/privacy/page.tsx
    src/lib/rbac/b2c-role-filters.ts
  </files>
  <action>
    1. **GlobalEraseFlow.tsx** (PRIV-08): Global erase with complete data deletion:
       - "Erase All My Data" button styled as danger action (red/rose, prominent warning styling)
       - Flow:
         a. Click opens a multi-step confirmation dialog:
            - Step 1: Warning card explaining what will be deleted (journeys, memories, messages, intent profile, privacy settings, all shared data). Use a checklist showing each data category with an icon.
            - Step 2: "Type DELETE MY DATA to confirm" -- requires exact text match
            - Step 3: Final "This cannot be undone" with red "Erase Everything" button
         b. On confirm: calls `services.privacy.executeGlobalErase(userId)`
         c. The executeGlobalErase service method must cascade:
            - Delete all journeys (localStorage key 'journeys' filtered by userId)
            - Delete all journey versions (localStorage key 'journey_versions')
            - Delete all memories (localStorage key 'memories' filtered by userId)
            - Delete all message threads where user is participant
            - Delete all messages in those threads
            - Delete intent profile (localStorage key 'intent_profiles')
            - Delete privacy settings (localStorage key 'privacy_settings')
            - Remove user from any sharing permissions in other users' memories
            - Log final audit event: { event: 'GLOBAL_ERASE', action: 'DELETE', metadata: { cascaded: true } }
         d. After successful erase: show "Your data has been erased" confirmation screen
         e. Auto-redirect to sign out (call signOut from next-auth)
         f. After logout: redirect to homepage

    2. **Update privacy page.tsx**: Add Global Erase section at the very bottom:
       - Section: "Danger Zone" with red/rose border
       - GlobalEraseFlow component
       - Clear warning text: "This will permanently delete all your data including journeys, memories, messages, and your intent profile. This action is irreversible."

    3. **b2c-role-filters.ts**: B2C role-based data filtering functions:
       - `filterJourneysForRole(journeys: Journey[], role: B2CRole, userId: string, privacySettings: PrivacySettings): Journey[]`:
         - UHNI: all journeys
         - Spouse: only journeys NOT marked invisible, only APPROVED status, only if sharing permissions include 'Spouse'
         - LegacyHeir: only shared journeys (sharingPermissions includes 'LegacyHeir'), only APPROVED, not invisible
         - ElanAdvisor: only journeys where advisor is in advisorVisibilityScope AND journey is not invisible. Additionally, check `privacySettings.advisorResourcePermissions[advisorId].journeys` -- if set to specific journey IDs, further filter to only those IDs; if 'all', show all visible; if 'none', show none.
       - `filterMemoriesForRole(memories: MemoryItem[], role: B2CRole, userId: string): MemoryItem[]`:
         - UHNI: all memories
         - Spouse: only memories where sharingPermissions includes 'Spouse', NOT locked
         - LegacyHeir: only memories where sharingPermissions includes 'LegacyHeir', NOT locked
         - ElanAdvisor: no memory access (returns empty array) unless `privacySettings.advisorResourcePermissions[advisorId].memories` is true
       - `filterMessagesForRole(threads: MessageThread[], role: B2CRole, userId: string): MessageThread[]`:
         - UHNI: all threads
         - Spouse: no access
         - LegacyHeir: no access
         - ElanAdvisor: only threads where advisor is a participant
       - `getNavLinksForRole(role: B2CRole): NavLink[]`:
         - UHNI: all nav links (Briefing, Intent, Journeys, Intelligence, Vault, Privacy)
         - Spouse: Journeys (filtered), Vault (filtered)
         - LegacyHeir: Journeys (filtered), Vault (filtered)
         - ElanAdvisor: Journeys (filtered), Messages, Intelligence (limited)
       - All filter functions use the RBAC permission matrices from permissions.ts as the source of truth

    AVOID: Don't implement actual sign-out in isolation -- use next-auth's signOut(). Don't skip any data category in cascade deletion. Don't show "Danger Zone" to non-UHNI roles.
  </action>
  <verify>
    `npm run build` succeeds. Test global erase flow:
    - Create some test data (journeys, memories, messages via other pages)
    - Navigate to /privacy, scroll to Danger Zone
    - Click "Erase All My Data" -> multi-step confirmation
    - Type "DELETE MY DATA" -> final confirm
    - All localStorage data for user is gone
    - Redirects to sign out
    - b2c-role-filters.ts exports all filter functions with correct logic
    - Advisor journey filter respects granular advisorResourcePermissions from Plan 06
  </verify>
  <done>
    Global erase flow with multi-step confirmation, cascade deletion across all entities, and logout (PRIV-08). B2C role filter functions for journeys, memories, messages, and nav links. Advisor filters respect granular per-journey permissions from advisorResourcePermissions. All data categories addressed in cascade. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build role-specific views for Spouse, Legacy Heir, and Advisor roles</name>
  <files>
    src/components/b2c/roles/SpouseView.tsx
    src/components/b2c/roles/LegacyHeirView.tsx
    src/components/b2c/roles/AdvisorView.tsx
    src/app/(b2c)/layout.tsx
  </files>
  <action>
    1. **Update B2C layout.tsx**: Role-aware navigation and layout:
       - Import useAuth hook to get current user's B2C role
       - Import getNavLinksForRole from b2c-role-filters
       - Dynamically render nav links based on role:
         - UHNI: all 6 links (Briefing, Intent, Journeys, Intelligence, Vault, Privacy)
         - Spouse: 2 links (Journeys, Vault) -- labeled "Shared Journeys", "Shared Memories"
         - LegacyHeir: 2 links (Journeys, Vault) -- labeled "Inherited Journeys", "Legacy Memories"
         - ElanAdvisor: 3 links (Journeys, Messages, Intelligence) -- labeled "Client Journeys", "Messages", "Client Brief"
       - Show role badge in the nav (e.g., "Spouse View", "Advisor View") for non-UHNI roles
       - For non-UHNI roles: hide the user menu's context switcher (they can't switch)

    2. **SpouseView.tsx** (ROLE-02): Spouse restricted view wrapper:
       - Used when B2C role is Spouse
       - Wraps journey and vault pages with filtering:
         - Journeys: uses filterJourneysForRole to show only shared, non-invisible, approved journeys
         - Vault: uses filterMemoriesForRole to show only shared, non-locked memories
       - No edit/delete/create actions -- view only
       - Show banner at top: "You are viewing [UHNI Name]'s shared experiences as their Spouse"
       - Hide: Intent, Intelligence, Privacy, Messages nav items

    3. **LegacyHeirView.tsx** (ROLE-03): Legacy Heir view-only:
       - Similar to Spouse but even more restricted
       - Journeys: only specifically shared journeys (tagged for heir)
       - Vault: only shared memories with LegacyHeir in sharingPermissions
       - Read-only on everything -- no actions at all
       - Show banner: "You are viewing shared memories as Legacy Heir"
       - Styled with a subtle sepia tone to differentiate from UHNI view

    4. **AdvisorView.tsx** (ROLE-04): Advisor contextual collaboration:
       - Journeys: filtered to journeys where advisor is in visibility scope, further filtered by granular advisorResourcePermissions (per-journey controls from Plan 06)
       - Journey detail: can view narrative, status, can add messages -- but CANNOT confirm, refine, archive, or toggle invisible
       - Messages: only threads where advisor is participant -- full read/write on messages
       - Intelligence: check `advisorResourcePermissions[advisorId].intelligence` -- if true, show emotional trends and lifestyle patterns but NOT renewal signals or exposure risk; if false, show "Intelligence Brief access has been restricted"
       - Show banner: "Advisor View - [UHNI Name]'s Profile"
       - No access to: Intent wizard/profile, Memory Vault (unless memories permission granted), Privacy settings

    5. **Role enforcement at page level**: For each B2C page component (briefing, intent, journeys, vault, intelligence, privacy, messages), add a role check at the TOP of the component function body using `const { user } = useAuth()` and `const role = user?.b2cRole ?? 'UHNI'`. Then check if the role has access to that page by calling `getNavLinksForRole(role)` and verifying the current path is included. If the role lacks permission for that page, render an `<AccessRestricted />` component (a styled full-page message: "This section is not available for your role. Contact the account holder for access." with a link to the first accessible page via `getNavLinksForRole(role)[0].href`). Do NOT use redirects -- render the restriction message in-place so the URL stays stable for debugging.

    NOTE: The existing pages built in Plans 02-06 should already work for UHNI (full access). This task adds the restricted views and role-switching logic.

    For TESTING: The mock auth system supports role switching. To test Spouse view, switch to Spouse role using the mock auth provider (or by modifying the mock current user hook to accept a role parameter).

    AVOID: Don't create separate page routes for each role -- same routes, different data/UI per role. Don't duplicate page code -- use the filter functions and RequirePermission gate. Don't forget to hide action buttons (edit, delete, create) for restricted roles.
  </action>
  <verify>
    `npm run build` succeeds. Test role enforcement:
    - UHNI role: all pages accessible, all actions available (ROLE-01)
    - Spouse role: only sees shared journeys and memories, no edit actions (ROLE-02)
    - LegacyHeir role: view-only shared content, no actions at all (ROLE-03)
    - Advisor role: sees filtered journeys (respecting per-journey granular permissions), messages, limited intel, can message but not modify journeys (ROLE-04)
    - Nav links update per role
    - Unauthorized page access shows AccessRestricted component in-place (not a redirect)
  </verify>
  <done>
    B2C layout dynamically adapts navigation per role. Spouse sees restricted partial access (ROLE-02). Legacy Heir sees view-only shared content (ROLE-03). Advisor sees contextual collaboration with filtered data respecting granular per-journey permissions (ROLE-04). UHNI has full sovereign control (ROLE-01). Role enforcement at page level uses useAuth hook and renders AccessRestricted component for unauthorized access. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete B2C Sovereign Experience across 7 plans:
    - Sovereign Briefing with 6 data sections
    - Intent Intelligence 5-step wizard with DNA generation
    - Journey Intelligence with narrative generation, confirm/refine/archive/invisible
    - Memory Vault with timeline, CRUD, family sharing, lock/export/erase
    - Advisor Collaboration messaging with journey threads
    - Intelligence Brief with magazine-style analytics
    - Privacy controls with discretion tier, granular advisor visibility, invites, global erase
    - Role enforcement for all 4 B2C roles
  </what-built>
  <how-to-verify>
    Run `npm run dev` and test the following flows:

    1. Navigate to /briefing -- verify Sovereign Briefing shows all 6 sections
    2. Navigate to /intent/wizard -- complete all 5 steps, verify DNA generation
    3. Navigate to /intent -- verify profile view with radar chart and alignment score
    4. Navigate to /journeys -- generate journeys, verify narrative cards appear
    5. Click a journey -- verify detail page, confirm flow, refine flow, archive, invisible toggle
    6. Navigate to /vault -- verify timeline, create a memory, add emotional tags
    7. Click a memory -- verify lock, export (downloads file), erase with "ERASE" confirmation
    8. Configure family sharing on a memory -- verify spouse/heir toggles
    9. Navigate to /messages -- create a thread, send messages
    10. Navigate to /intelligence -- verify magazine layout with 4 sections and charts
    11. Navigate to /privacy -- verify discretion tier, invisible default, advisor scope
    12. Expand "Advanced Settings" in advisor visibility -- verify per-journey checkboxes and resource type toggles
    13. Test invite flows (spouse/heir/advisor) end-to-end
    14. Test global erase -- WARNING: this deletes all data
    15. Switch to Spouse role -- verify restricted view
    16. Switch to Advisor role -- verify limited access with messaging, verify granular journey filtering
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to address</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- Global erase: multi-step confirm -> cascade deletion -> logout
- Spouse: restricted view of shared journeys/memories only
- Legacy Heir: view-only access to shared content
- Advisor: contextual access with messaging, limited intel, per-journey granular filtering
- Nav links adapt per role
- Unauthorized page access shows AccessRestricted in-place
- All PRIV-08, ROLE-01 through ROLE-04 addressed
</verification>

<success_criteria>
1. UHNI can trigger global erase with complete data deletion, cascade, confirmation, and logout (Success Criteria #18)
2. Spouse role sees restricted partial access per UHNI configuration (Success Criteria #20)
3. Legacy Heir role sees view-only access to shared memories and selected journeys (Success Criteria #21)
4. Elan Advisor role sees contextual collaboration access with journey thread visibility, granular per-journey filtering, and limited intel view (Success Criteria #22)
5. UHNI role has full sovereign control (ROLE-01)
</success_criteria>

<output>
After completion, create `.planning/phases/03-b2c-sovereign-experience/03-07-SUMMARY.md`
</output>
