---
phase: 04-b2b-institutional-portal
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(b2b)/clients/page.tsx
  - src/app/(b2b)/clients/[id]/page.tsx
  - src/app/(b2b)/clients/new/page.tsx
  - src/components/b2b/clients/ClientOnboardingWizard.tsx
  - src/components/b2b/clients/RMIntakeWizard.tsx
  - src/components/b2b/clients/AdvisorAssignment.tsx
  - src/components/b2b/clients/JourneyTimeline.tsx
  - src/components/b2b/clients/IntelligenceHistory.tsx
autonomous: true

must_haves:
  truths:
    - "RM can view list of all assigned UHNI clients with search, sort, and filter"
    - "RM can create new UHNI client record with end-to-end onboarding wizard"
    - "RM can conduct emotional intake wizard on behalf of client"
    - "RM can assign and reassign advisors to a client"
    - "RM can view per-client journey lifecycle timeline with status progression"
    - "RM can view client intelligence history with historical data and trends"
  artifacts:
    - path: "src/app/(b2b)/clients/page.tsx"
      provides: "Client list page with DataTable, search, filters, and New Client CTA"
      min_lines: 60
    - path: "src/app/(b2b)/clients/[id]/page.tsx"
      provides: "Client detail page with tabbed sections (overview, journeys, intelligence, advisors)"
      min_lines: 100
    - path: "src/app/(b2b)/clients/new/page.tsx"
      provides: "New client onboarding page hosting the wizard"
      min_lines: 20
    - path: "src/components/b2b/clients/ClientOnboardingWizard.tsx"
      provides: "Multi-step client creation wizard"
      min_lines: 100
    - path: "src/components/b2b/clients/RMIntakeWizard.tsx"
      provides: "RM-led emotional intake wizard (reuses B2C intake patterns)"
      min_lines: 80
  key_links:
    - from: "src/app/(b2b)/clients/page.tsx"
      to: "src/lib/hooks/useServices.ts"
      via: "fetches clients from services.client.getClientsByRM"
      pattern: "services\\.client"
    - from: "src/components/b2b/clients/ClientOnboardingWizard.tsx"
      to: "src/lib/hooks/useWizard.ts"
      via: "reuses useWizard hook from B2C for multi-step form"
      pattern: "useWizard"
    - from: "src/app/(b2b)/clients/[id]/page.tsx"
      to: "src/components/b2b/tables/DataTable.tsx"
      via: "journey lifecycle table uses DataTable"
      pattern: "DataTable"
---

<objective>
Build the UHNI Client Profile Management pages (CLNT-01 through CLNT-05): client list with DataTable, client detail with tabbed sections, end-to-end client onboarding wizard, RM-led emotional intake, advisor assignment panel, journey lifecycle timeline, and intelligence history view.

Purpose: Enables Relationship Managers to manage their full portfolio of UHNI clients — the core operational workflow of the B2B portal.

Output: Complete client management flow from listing to creation to detailed management.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-b2b-institutional-portal/04-RESEARCH.md

Key existing files:
@src/components/b2b/tables/DataTable.tsx (from Plan 01 — reusable data table)
@src/components/b2b/layouts/StatsRow.tsx (from Plan 01)
@src/components/b2b/layouts/StatusBadge.tsx (from Plan 01)
@src/lib/services/mock/client.mock.ts (from Plan 01 — MockClientService)
@src/lib/hooks/useServices.ts (extended in Plan 01 with client service)
@src/lib/hooks/useWizard.ts (existing multi-step wizard hook from B2C Phase 3)
@src/lib/types/entities.ts (ClientRecord, IntentProfile, EmotionalDrivers types)
@src/lib/types/validation.ts (CreateClientRecordSchema)
@src/lib/rbac/usePermission.ts (useCan hook)
@src/components/b2c/wizards/ (B2C intake wizard patterns to reference)
@src/components/shared/Card/index.tsx
@src/components/shared/Modal/index.tsx
@src/components/shared/Tabs/index.tsx
@src/components/shared/Input/index.tsx
@src/components/shared/Button/index.tsx
@src/components/shared/Select/index.tsx

Prior plan SUMMARY (needed for DataTable, service references):
@.planning/phases/04-b2b-institutional-portal/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client list page and client onboarding wizard</name>
  <files>
    src/app/(b2b)/clients/page.tsx
    src/app/(b2b)/clients/new/page.tsx
    src/components/b2b/clients/ClientOnboardingWizard.tsx
  </files>
  <action>
    **Step 1: Client List Page**

    Create `src/app/(b2b)/clients/page.tsx` as `'use client'` component.

    Page structure:
    - Header: "Client Portfolio" title + subtitle + "New Client" Button (primary variant, links to `/clients/new`)
    - Permission gate: Require `can(Permission.READ, 'client')`, show access denied message if not permitted
    - StatsRow with 4 stats: Total Clients, Active (status=Active count), Pending Onboarding (status=Onboarding/Pending), High Risk (riskCategory=High/Critical count)
    - DataTable with columns:
      - Client Name (accessorKey: 'name', sorted by default)
      - Status (StatusBadge)
      - Risk Level (StatusBadge with risk color map: Low=olive, Medium=gold, High=rose, Critical=red)
      - Active Journeys (number)
      - NDA Status (StatusBadge with NDA color map)
      - Last Activity (formatted with `formatDistanceToNow` from date-fns)
    - Row click navigates to `/clients/${row.id}` using `useRouter`
    - Search on client name column
    - Loading skeleton while data fetches
    - Fetch clients using `services.client.getClientsByRM(MOCK_RM_USER_ID)` on mount

    **Step 2: New Client Page**

    Create `src/app/(b2b)/clients/new/page.tsx` — simple page that hosts the wizard:
    - Header: "Onboard New Client"
    - Breadcrumb: Portfolio / Clients / New Client
    - Permission gate: `can(Permission.WRITE, 'client')`
    - Renders `<ClientOnboardingWizard />` with onComplete callback that navigates to `/clients/{newClientId}` and shows `toast.success('Client onboarded successfully')`

    **Step 3: Client Onboarding Wizard**

    Create `src/components/b2b/clients/ClientOnboardingWizard.tsx`.

    Use the existing `useWizard` hook pattern from B2C Phase 3 (same localStorage persistence, per-step validation).

    4 steps:
    1. **Client Details**: Name, email, phone (optional), preferred contact method. Validate with Zod.
    2. **Risk Assessment**: Initial risk category selection (dropdown), risk notes (textarea), compliance flags (multi-select checkboxes for common flags like "PEP", "Sanctions Screen Required", "Enhanced Due Diligence").
    3. **NDA & Compliance**: NDA status selector (Active/Pending/None), NDA expiry date (if Active, use date input), initial compliance notes.
    4. **Review & Confirm**: Summary of all entered data. "Confirm Onboarding" button that calls `services.client.createClient()` followed by `services.risk.createRiskRecord()` for the initial risk assessment.

    Wizard UI: Card-based layout, step progress indicator at top (Step 1 of 4 with labels), Previous/Next navigation, luxury B2B styling (font-sans body, font-serif headings, slate/rose palette).

    On completion: Navigate to client detail page + toast success.
  </action>
  <verify>
    Run `npm run build` to confirm no TypeScript errors. Navigate to `/clients`:
    - Client list renders with mock data in DataTable
    - Sorting, search, and pagination work
    - Click "New Client" navigates to `/clients/new`
    - Complete wizard end-to-end: fill all 4 steps, confirm, redirected to new client detail page
    - Toast notification appears on success
  </verify>
  <done>
    Client list page renders all RM's clients in a searchable, sortable DataTable. Client onboarding wizard completes end-to-end: 4 steps, creates client + risk records, navigates to detail page with toast confirmation. CLNT-01 complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client detail page with RM intake, advisor assignment, journey timeline, intelligence history</name>
  <files>
    src/app/(b2b)/clients/[id]/page.tsx
    src/components/b2b/clients/RMIntakeWizard.tsx
    src/components/b2b/clients/AdvisorAssignment.tsx
    src/components/b2b/clients/JourneyTimeline.tsx
    src/components/b2b/clients/IntelligenceHistory.tsx
  </files>
  <action>
    **Step 1: Client Detail Page**

    Create `src/app/(b2b)/clients/[id]/page.tsx` as `'use client'` component.

    Page structure:
    - Breadcrumb: Portfolio / Clients / {Client Name}
    - Header section: Client name (font-serif text-3xl), status badge, risk badge, "Edit" button
    - Tabbed interface using existing Tabs component with 4 tabs:
      - **Overview** (default): Client summary card (name, email, status, risk, NDA, dates), EmotionalDrivers radar chart (if profile exists), quick stats (journey count, advisor count)
      - **Journeys**: JourneyTimeline component showing per-client journey lifecycle
      - **Intelligence**: IntelligenceHistory component showing historical trends
      - **Advisors**: AdvisorAssignment component for managing advisor assignments
    - Each tab has "Emotional Intake" CTA button that opens RMIntakeWizard modal (if no emotionalProfile yet, show prominent CTA; if exists, show "Re-assess" button)
    - Load client data with `services.client.getClientById(params.id)`
    - Loading skeleton while data fetches
    - 404 handling if client not found

    **Step 2: RM-Led Emotional Intake Wizard**

    Create `src/components/b2b/clients/RMIntakeWizard.tsx`.

    This is the B2B version of the B2C intake wizard. RM conducts it on behalf of client (e.g., during a phone call or meeting). Renders as a Modal overlay.

    5 steps (mirrors B2C but with RM framing):
    1. **Life Phase**: Select client's life phase (Building/Preserving/Transitioning/Legacy Planning) with descriptive cards
    2. **Emotional Outcome**: Select primary emotional outcomes for the client (card-based selection, 2-3 selections)
    3. **Travel Mode**: Client's preferred travel mode (Luxury/Adventure/Wellness/Cultural/Exclusive Access)
    4. **Priorities**: Rank client priorities (drag-or-click reorder, or numbered selection)
    5. **Discretion Level**: Select client discretion preference (High/Medium/Standard) with explanations

    On completion: Call `services.intent.createProfile()` for the client's userId, then update client's `emotionalProfile` field. Close modal, refresh client data. Toast success: "Emotional profile created for {clientName}".

    Props: `{ clientId: string; clientName: string; onComplete: () => void; open: boolean; onOpenChange: (open: boolean) => void }`

    Reuse existing `useWizard` hook. Reference B2C wizard patterns in `src/components/b2c/wizards/` for visual style but adapt text for RM perspective ("Client's life phase" instead of "Your life phase").

    **Step 3: Advisor Assignment Component**

    Create `src/components/b2b/clients/AdvisorAssignment.tsx`.

    Shows:
    - List of currently assigned advisors (name, role, assigned date) in a small table
    - "Assign Advisor" button that opens a modal with a dropdown/search of available advisors (mock list from `services.user` — filter users with ElanAdvisor role)
    - Each advisor row has "Remove" action (with confirmation dialog)
    - On assign: calls `services.client.assignAdvisor(clientId, advisorId)` + toast success
    - On remove: calls `services.client.removeAdvisor(clientId, advisorId)` + toast success
    - Permission gated: only show assign/remove if `can(Permission.ASSIGN, 'client')`

    **Step 4: Journey Timeline Component**

    Create `src/components/b2b/clients/JourneyTimeline.tsx`.

    Shows per-client journey lifecycle as a vertical timeline:
    - Fetch journeys for this client using `services.journey.getJourneys(clientRecord.userId, 'b2b')`
    - Each journey shows: title, current status (StatusBadge), created date, last updated
    - Visual timeline: vertical line on left, circle markers at each journey, color-coded by status
    - Click on journey navigates to `/journeys/{journeyId}` (will be built in Plan 03)
    - If no journeys, show empty state with "Generate Journey" CTA (links to journey creation in Plan 03)
    - Small DataTable below timeline for detailed list view (toggle between timeline and table view)

    **Step 5: Intelligence History Component**

    Create `src/components/b2b/clients/IntelligenceHistory.tsx`.

    Shows historical data and trends for a client:
    - Emotional profile changes over time (if multiple intent profiles exist — show timeline of changes)
    - Risk score history: Recharts LineChart showing risk score over time (mock 6 data points over 6 months)
    - Recent audit events for this client: small DataTable of last 10 audit events (fetched from `services.audit.getByResource('client', clientId)`)
    - Key metrics: days since onboarding, total journeys completed, current risk trend (up/down/stable arrow)
    - If no historical data available, show "Intelligence data will accumulate as client activity grows" message
  </action>
  <verify>
    Run `npm run build` to confirm no TypeScript errors. Navigate to `/clients/{id}`:
    - Client detail page loads with all 4 tabs
    - Overview tab shows client summary with radar chart if emotional profile exists
    - Click "Emotional Intake" opens RMIntakeWizard modal, complete all 5 steps, profile saved
    - Advisors tab shows assigned advisors, can assign/remove
    - Journeys tab shows timeline (may be empty for new clients)
    - Intelligence tab shows history data and charts
  </verify>
  <done>
    Client detail page renders 4 tabbed sections. RM-led emotional intake wizard completes end-to-end as modal flow. Advisors can be assigned/removed. Journey timeline shows per-client journey progression. Intelligence history shows trends and audit trail. CLNT-02 through CLNT-05 complete.
  </done>
</task>

</tasks>

<verification>
- Client list at `/clients` shows all RM's clients with sortable DataTable
- New client wizard at `/clients/new` completes end-to-end (4 steps -> creates client + risk record)
- Client detail at `/clients/{id}` shows tabbed view with Overview, Journeys, Intelligence, Advisors
- RM emotional intake wizard opens as modal, 5 steps, saves intent profile for client
- Advisor assignment works (add/remove with confirmation)
- Journey timeline shows per-client journey status progression
- Intelligence history shows risk trends and audit events
- All pages permission-gated with useCan() checks
</verification>

<success_criteria>
All 5 CLNT requirements met: CLNT-01 (create records with onboarding), CLNT-02 (RM-led emotional intake), CLNT-03 (assign/reassign advisors), CLNT-04 (journey lifecycle tracking), CLNT-05 (intelligence history). Every CTA has an end-to-end flow with no dead buttons.
</success_criteria>

<output>
After completion, create `.planning/phases/04-b2b-institutional-portal/04-02-SUMMARY.md`
</output>
