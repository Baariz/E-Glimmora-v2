---
phase: 05-platform-administration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/(admin)/members/page.tsx
  - src/app/(admin)/members/[id]/page.tsx
  - src/components/admin/members/MemberActions.tsx
  - src/app/(admin)/institutions/page.tsx
  - src/app/(admin)/institutions/new/page.tsx
  - src/app/(admin)/institutions/[id]/page.tsx
  - src/components/admin/institutions/InstitutionOnboardingWizard.tsx
  - src/components/admin/institutions/InstitutionActions.tsx
  - src/lib/services/interfaces/IUserService.ts
  - src/lib/services/mock/user.mock.ts
  - src/lib/services/interfaces/IInstitutionService.ts
  - src/lib/services/mock/institution.mock.ts
autonomous: true

must_haves:
  truths:
    - "Super Admin can view all UHNI members in a searchable, sortable DataTable with status indicators"
    - "Super Admin can approve a pending member, suspend an active member, or remove a member"
    - "Every member state change (approve/suspend/remove) is logged in the audit trail"
    - "Super Admin can view a member detail page with profile info, role assignments, and audit history"
    - "Super Admin can view all institutions in a DataTable with status, type, and tier columns"
    - "Super Admin can onboard a new institution through a guided 3-step wizard"
    - "Super Admin can edit institution details (name, type, tier)"
    - "Super Admin can suspend or reactivate an institution"
  artifacts:
    - path: "src/app/(admin)/members/page.tsx"
      provides: "Member management list with DataTable, stats, and actions"
      min_lines: 150
    - path: "src/app/(admin)/members/[id]/page.tsx"
      provides: "Member detail page with profile, roles, audit history"
      min_lines: 100
    - path: "src/components/admin/members/MemberActions.tsx"
      provides: "Action buttons for approve/suspend/remove with audit logging"
      min_lines: 60
    - path: "src/app/(admin)/institutions/page.tsx"
      provides: "Institution management list with DataTable and actions"
      min_lines: 120
    - path: "src/app/(admin)/institutions/new/page.tsx"
      provides: "Institution onboarding wizard page"
      min_lines: 30
    - path: "src/components/admin/institutions/InstitutionOnboardingWizard.tsx"
      provides: "3-step guided setup: basics, configuration, review"
      min_lines: 150
    - path: "src/app/(admin)/institutions/[id]/page.tsx"
      provides: "Institution detail page with edit, suspend, branding preview"
      min_lines: 120
  key_links:
    - from: "src/components/admin/members/MemberActions.tsx"
      to: "services.audit.log"
      via: "Audit logging on every state change"
      pattern: "audit\\.log"
    - from: "src/components/admin/institutions/InstitutionOnboardingWizard.tsx"
      to: "services.institution.createInstitution"
      via: "Service call on wizard completion"
      pattern: "createInstitution"
    - from: "src/app/(admin)/members/[id]/page.tsx"
      to: "services.audit.getByUser"
      via: "Fetch audit trail for member"
      pattern: "getByUser"
---

<objective>
Build UHNI member management and institution management for the Super Admin platform.

Purpose: Delivers ADMN-03 (member management with approve/suspend/remove), ADMN-04 (institution onboarding with guided setup), and ADMN-05 (institution edit/suspend/remove) — core platform operations that the Super Admin needs for daily operations.
Output: Member list + detail pages with state management, institution list + detail pages, and institution onboarding wizard.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-platform-administration/05-01-SUMMARY.md

Key references:
@src/components/b2b/tables/DataTable.tsx — Reuse for member and institution lists
@src/components/b2b/layouts/StatsRow.tsx — Reuse for stats
@src/components/b2b/layouts/StatusBadge.tsx — Reuse for status display
@src/components/shared/Modal.tsx — For confirmation dialogs
@src/lib/services/interfaces/IUserService.ts — Needs enhancement for member management
@src/lib/services/mock/user.mock.ts — Needs enhancement with member seed data and status management
@src/lib/services/interfaces/IInstitutionService.ts — Needs enhancement for reactivate
@src/lib/services/mock/institution.mock.ts — Needs seed data and reactivation
@src/lib/services/mock/audit.mock.ts — Audit logging for state changes
@src/lib/hooks/useWizard.ts — Existing wizard pattern for institution onboarding
@src/lib/types/entities.ts — User, Institution entity types
@src/lib/types/roles.ts — UserRoles, B2CRole, B2BRole, AdminRole
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build UHNI member management (list, detail, actions)</name>
  <files>
    src/app/(admin)/members/page.tsx
    src/app/(admin)/members/[id]/page.tsx
    src/components/admin/members/MemberActions.tsx
    src/lib/services/interfaces/IUserService.ts
    src/lib/services/mock/user.mock.ts
  </files>
  <action>
  **Service Enhancement:**

  1. Add to IUserService interface:
     - `getUsers(): Promise<User[]>` (if not present)
     - `updateUserStatus(id: string, status: 'active' | 'suspended' | 'removed'): Promise<User>`
     - `getUserById(id: string): Promise<User | null>` (if not present)
  2. Implement in MockUserService:
     - `updateUserStatus`: updates a `status` field on the user. Since the User entity doesn't have a status field, add the status update logic using the `erasedAt` field — suspended users get `erasedAt: 'SUSPENDED:' + ISO date`, removed users get `erasedAt: 'REMOVED:' + ISO date`, active users get `erasedAt: undefined`
     - Seed 8-12 mock users with diverse profiles: mix of B2C (UHNI, Spouse, LegacyHeir), B2B (RM, PrivateBanker, ComplianceOfficer), and Admin roles. Include 2-3 in pending state (recently created, `erasedAt` is undefined, no roles yet — these are "pending approval"), 1-2 suspended, rest active.
     - Ensure `getUsers()` returns all users (the method likely exists)

  **MemberActions Component:**

  Create `src/components/admin/members/MemberActions.tsx`:
  1. Props: `user: User`, `onAction: () => void` (refresh callback)
  2. Three action buttons based on current user state:
     - If pending (no roles assigned): "Approve" button (teal) — sets status active, assigns default role
     - If active: "Suspend" button (amber) — confirmation via window.confirm("Are you sure you want to suspend {name}?")
     - If suspended: "Reactivate" button (teal), "Remove" button (red)
     - If removed: "Reactivate" button only
  3. Every action calls `services.audit.log()` with:
     - event: `user.approve`, `user.suspend`, `user.remove`, or `user.reactivate`
     - userId: `'super-admin'` (the acting admin)
     - resourceId: the user's id
     - resourceType: `'user'`
     - context: `'admin'`
     - action: `'UPDATE'`
     - previousState / newState with the status change
  4. Show toast (sonner) on success: "Member {action}d successfully"

  **Members List Page (members/page.tsx):**

  Create `src/app/(admin)/members/page.tsx`:
  1. `'use client'` with useServices, useState, useEffect
  2. Page header: "Member Management" (font-serif, text-3xl), description text
  3. Stats row: Total Members, Active, Pending Approval, Suspended, Removed
  4. DataTable with columns:
     - Name: user name, clickable link to /members/[id]
     - Email: user email
     - Roles: display assigned roles as colored badges (B2C=rose, B2B=teal, Admin=slate)
     - Status: StatusBadge — Active (green), Pending (amber), Suspended (gray), Removed (red). Derive status from user state: no roles = Pending, erasedAt starts with SUSPENDED = Suspended, erasedAt starts with REMOVED = Removed, else Active
     - Joined: relative date from createdAt
     - Actions: inline MemberActions component (compact mode)
  5. Search by name column
  6. Loading state

  **Member Detail Page (members/[id]/page.tsx):**

  Create `src/app/(admin)/members/[id]/page.tsx`:
  1. `'use client'` with useParams for id
  2. Load user by ID via services.user.getUserById
  3. Profile section: name, email, avatar placeholder, created date, current status
  4. Role Assignments section: display all assigned roles across domains (B2C, B2B, Admin) with context labels
  5. MemberActions component (full size) for approve/suspend/remove
  6. Audit History section: load audit events for this user via `services.audit.getByUser(userId)`, display as timeline (similar to dashboard recent activity pattern)
  7. Back link to /members
  8. Loading and not-found states
  </action>
  <verify>
  - `npm run build` completes without errors
  - Members page shows DataTable with seeded users
  - Stats row counts are correct
  - Clicking member name navigates to detail page
  - Approve/suspend/remove actions work and log audit events
  - Member detail shows profile, roles, and audit history
  </verify>
  <done>
  Super Admin can view all members in searchable DataTable, approve pending members, suspend active members, remove members, and reactivate suspended/removed members. Every state change is logged immutably in audit trail. Member detail page shows profile, roles, and audit history.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build institution management (list, onboarding wizard, detail/edit)</name>
  <files>
    src/app/(admin)/institutions/page.tsx
    src/app/(admin)/institutions/new/page.tsx
    src/app/(admin)/institutions/[id]/page.tsx
    src/components/admin/institutions/InstitutionOnboardingWizard.tsx
    src/components/admin/institutions/InstitutionActions.tsx
    src/lib/services/interfaces/IInstitutionService.ts
    src/lib/services/mock/institution.mock.ts
  </files>
  <action>
  **Service Enhancement:**

  1. Add to IInstitutionService interface:
     - `reactivateInstitution(id: string): Promise<Institution>` — sets status back to Active
     - `removeInstitution(id: string): Promise<Institution>` — sets status to a "Removed" state (add 'Removed' to InstitutionStatus type in entities.ts if not present)
  2. Implement in MockInstitutionService:
     - `reactivateInstitution`: sets status to 'Active', updates updatedAt
     - `removeInstitution`: sets status to a remove indicator, updates updatedAt
     - Seed 6-8 mock institutions with diverse data: mix of types (Private Bank, Family Office, Wealth Manager), tiers (Platinum, Gold, Silver), statuses (Active, Pending, Suspended). Include realistic names (e.g., "Meridian Private Bank", "Hartwell Family Office", "Sovereign Wealth Partners"). Add contractStart dates spread over last 2 years.

  **InstitutionOnboardingWizard Component:**

  Create `src/components/admin/institutions/InstitutionOnboardingWizard.tsx`:
  1. Use the existing `useWizard` hook pattern from B2C
  2. 3-step wizard:
     - **Step 1 — Institution Details**: Name (text input, required), Type (select: Private Bank / Family Office / Wealth Manager), Tier (select: Platinum / Gold / Silver)
     - **Step 2 — Configuration**: Contract Start Date (date input, default today), Primary Contact Email (text input), Notes (textarea, optional)
     - **Step 3 — Review & Confirm**: Summary of all entered data in a clean card layout, "Create Institution" button
  3. On submit: call `services.institution.createInstitution(data)` with the collected fields
  4. Log audit event: `institution.create` with context 'admin'
  5. On success: show success state with institution name and "View Institution" link to /institutions/[id]
  6. Use card-based layout for each step (consistent with B2C wizard luxury feel but simpler admin aesthetic)
  7. Progress indicator showing current step (1/2/3) at top

  **InstitutionActions Component:**

  Create `src/components/admin/institutions/InstitutionActions.tsx`:
  1. Props: `institution: Institution`, `onAction: () => void` (refresh callback)
  2. Action buttons based on status:
     - Active: "Suspend" (amber), "Edit" (slate)
     - Pending: "Activate" (teal), "Edit" (slate)
     - Suspended: "Reactivate" (teal), "Remove" (red)
  3. Every action logs audit event with previousState/newState
  4. Confirmation via window.confirm for suspend/remove
  5. Toast on success

  **Institutions List Page (institutions/page.tsx):**

  Create `src/app/(admin)/institutions/page.tsx`:
  1. Page header: "Institution Management" with "Onboard Institution" button linking to /institutions/new
  2. Stats row: Total Institutions, Active, Pending, Suspended — computed from data
  3. DataTable with columns:
     - Name: clickable link to /institutions/[id]
     - Type: text (Private Bank / Family Office / Wealth Manager)
     - Tier: badge (Platinum=gold, Gold=amber, Silver=slate)
     - Status: StatusBadge (Active=green, Pending=amber, Suspended=gray)
     - Contract Start: formatted date
     - Actions: inline InstitutionActions (compact)
  4. Search by name
  5. Loading state

  **Institution Onboarding Page (institutions/new/page.tsx):**

  Simple page wrapper for the InstitutionOnboardingWizard component:
  1. Page header: "Onboard New Institution"
  2. Back link to /institutions
  3. Render InstitutionOnboardingWizard

  **Institution Detail Page (institutions/[id]/page.tsx):**

  Create `src/app/(admin)/institutions/[id]/page.tsx`:
  1. Load institution by ID
  2. Profile section: name, type, tier, status, contract start, created/updated dates
  3. Edit mode: toggle "Edit" button to make name, type, tier fields editable. Save calls `services.institution.updateInstitution` and logs audit event.
  4. InstitutionActions for suspend/reactivate/remove
  5. Associated data section: "Associated Members" — filter users by institutionId (if available in mock data). Show count and list of member names.
  6. Audit trail: show audit events for this institution via filtering audit events by resourceType='institution' and resourceId
  7. Back link to /institutions
  8. Loading and not-found states
  </action>
  <verify>
  - `npm run build` completes without errors
  - Institutions page shows DataTable with seeded institutions
  - "Onboard Institution" navigates to wizard page
  - Complete wizard creates institution and shows success
  - Institution detail page shows profile with edit capability
  - Suspend/reactivate/remove actions work with audit logging
  - Member detail shows audit trail for member
  - Institution detail shows audit trail for institution
  </verify>
  <done>
  Super Admin can view all institutions in DataTable, onboard new institutions via 3-step guided wizard, edit institution details, suspend/reactivate/remove institutions, and view associated members and audit trail. All state changes logged in audit trail.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` — no TypeScript errors
2. Navigate to /members — DataTable with mock users, stats row accurate
3. Click member name — detail page with profile, roles, audit history
4. Approve a pending member — status changes, audit event logged
5. Suspend an active member — status changes, audit event logged
6. Navigate to /institutions — DataTable with mock institutions
7. Click "Onboard Institution" — wizard loads at /institutions/new
8. Complete 3-step wizard — institution created, success shown
9. Click institution name — detail page with edit capability
10. Edit institution name — saves successfully, audit event logged
11. Suspend institution — status changes with audit trail
</verification>

<success_criteria>
- ADMN-03 satisfied: Super Admin can approve, suspend, or remove UHNI members with state change audit trail
- ADMN-04 satisfied: Super Admin can onboard new institutions with guided 3-step setup workflow
- ADMN-05 satisfied: Super Admin can edit, suspend, or remove institutions
- GVRN-02 partial: Every state change on members and institutions logged immutably in audit trail
- All pages reuse existing B2B patterns (DataTable, StatsRow, StatusBadge)
</success_criteria>

<output>
After completion, create `.planning/phases/05-platform-administration/05-02-SUMMARY.md`
</output>
