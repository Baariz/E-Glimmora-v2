---
phase: 01-foundation-design-system
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/types/entities.ts
  - src/lib/types/roles.ts
  - src/lib/types/permissions.ts
  - src/lib/types/validation.ts
  - src/lib/types/index.ts
  - src/lib/services/interfaces/IJourneyService.ts
  - src/lib/services/interfaces/IMemoryService.ts
  - src/lib/services/interfaces/IMessageService.ts
  - src/lib/services/interfaces/IIntentService.ts
  - src/lib/services/interfaces/IUserService.ts
  - src/lib/services/interfaces/IInstitutionService.ts
  - src/lib/services/interfaces/IRiskService.ts
  - src/lib/services/interfaces/IContractService.ts
  - src/lib/services/interfaces/IAuditService.ts
  - src/lib/services/interfaces/IPrivacyService.ts
  - src/lib/services/interfaces/index.ts
  - src/lib/services/mock/base.mock.ts
  - src/lib/services/mock/journey.mock.ts
  - src/lib/services/mock/memory.mock.ts
  - src/lib/services/mock/message.mock.ts
  - src/lib/services/mock/intent.mock.ts
  - src/lib/services/mock/user.mock.ts
  - src/lib/services/mock/institution.mock.ts
  - src/lib/services/config.ts
  - src/lib/services/index.ts
autonomous: true

must_haves:
  truths:
    - "All 15+ entity types compile without TypeScript errors"
    - "Zod validation schemas catch invalid data at runtime (e.g., missing required fields, invalid enum values)"
    - "Service interfaces define contracts for all CRUD operations on every entity"
    - "Mock services return production-shaped data with realistic delays (300-500ms)"
    - "Mock services persist data in localStorage across page refreshes"
    - "Service registry exports a unified services object selecting mock or API based on environment variable"
  artifacts:
    - path: "src/lib/types/entities.ts"
      provides: "All 15+ entity type definitions"
      contains: "User, Institution, IntentProfile, Journey, JourneyVersion, MemoryItem, MessageThread, Message, PrivacySettings, AccessPermission, RiskRecord, Contract, RevenueRecord, AuditEvent"
      min_lines: 150
    - path: "src/lib/types/roles.ts"
      provides: "Role enums for B2C, B2B, Admin"
      contains: "B2CRole, B2BRole, AdminRole"
    - path: "src/lib/types/validation.ts"
      provides: "Zod schemas for input validation"
      contains: "CreateJourneySchema, CreateMemorySchema"
    - path: "src/lib/services/interfaces/IJourneyService.ts"
      provides: "Journey service contract"
      exports: ["IJourneyService"]
    - path: "src/lib/services/mock/journey.mock.ts"
      provides: "Mock journey service with localStorage"
      contains: "implements IJourneyService"
    - path: "src/lib/services/config.ts"
      provides: "Environment-based service selection"
      contains: "NEXT_PUBLIC_USE_MOCK_SERVICES"
    - path: "src/lib/services/index.ts"
      provides: "Service registry export"
      exports: ["services"]
  key_links:
    - from: "src/lib/services/interfaces/IJourneyService.ts"
      to: "src/lib/types/entities.ts"
      via: "import { Journey, CreateJourneyInput }"
      pattern: "import.*entities"
    - from: "src/lib/services/mock/journey.mock.ts"
      to: "src/lib/services/interfaces/IJourneyService.ts"
      via: "implements IJourneyService"
      pattern: "implements IJourneyService"
    - from: "src/lib/services/config.ts"
      to: "src/lib/services/mock/"
      via: "import mock services"
      pattern: "import.*mock"
    - from: "src/lib/types/validation.ts"
      to: "src/lib/types/entities.ts"
      via: "Zod infer produces same types as entity interfaces"
      pattern: "z\\.infer"
---

<objective>
Define all TypeScript entity types, Zod validation schemas, service interface contracts, and mock localStorage implementations. This creates the data layer that features will consume.

Purpose: Types and service contracts must exist before any feature can be built. Mock services enable frontend development without a backend. The abstraction layer ensures seamless swap to real APIs later.
Output: Complete type system (15+ entities), validation schemas, 10 service interfaces, and mock implementations for the most-used services.
</objective>

<execution_context>
@/Users/kavi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-design-system/01-RESEARCH.md (Pattern 7: Service Abstraction, Pattern 10: Entity Types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define all entity types, role enums, and Zod validation schemas</name>
  <files>
    src/lib/types/entities.ts
    src/lib/types/roles.ts
    src/lib/types/permissions.ts
    src/lib/types/validation.ts
    src/lib/types/index.ts
  </files>
  <action>
    1. Create `src/lib/types/roles.ts`:
       - B2CRole enum: UHNI, Spouse, LegacyHeir, ElanAdvisor
       - B2BRole enum: RelationshipManager, PrivateBanker, FamilyOfficeDirector, ComplianceOfficer, InstitutionalAdmin, UHNIPortal
       - AdminRole enum: SuperAdmin
       - Type alias: Role = B2CRole | B2BRole | AdminRole
       - Interface: UserRoles { b2c?: B2CRole; b2b?: B2BRole; admin?: AdminRole }
       - Type alias: DomainContext = 'b2c' | 'b2b' | 'admin'

    2. Create `src/lib/types/permissions.ts`:
       - Permission enum: READ, WRITE, DELETE, APPROVE, EXPORT, ASSIGN, CONFIGURE
       - Resource type (string union): 'journey' | 'vault' | 'intent' | 'privacy' | 'client' | 'risk' | 'audit' | 'invite' | 'institution' | 'message' | 'contract' | 'revenue' | 'user'
       - PermissionCheck interface: { action: Permission; resource: Resource }

    3. Create `src/lib/types/entities.ts` with ALL 15+ entities:
       - User: id, email, name, roles (UserRoles), institutionId?, avatarUrl?, createdAt, updatedAt, erasedAt?
       - Institution: id, name, type (Private Bank | Family Office | Wealth Manager), tier (Platinum | Gold | Silver), status (Active | Pending | Suspended), contractStart, contractEnd?, createdAt, updatedAt
       - IntentProfile: id, userId, emotionalDrivers (security/adventure/legacy/recognition/autonomy as 0-100), riskTolerance, values[], lifeStage, travelMode?, priorities?, discretionPreference?, createdAt, updatedAt
       - Journey: id, userId, institutionId?, assignedRM?, title, narrative, category enum, status (JourneyStatus enum), versions (JourneyVersion[]), currentVersionId, riskSummary?, discretionLevel?, isInvisible (boolean), emotionalObjective?, strategicReasoning?, createdAt, updatedAt
       - JourneyStatus enum: DRAFT, RM_REVIEW, COMPLIANCE_REVIEW, APPROVED, PRESENTED, EXECUTED, ARCHIVED
       - JourneyVersion: id, journeyId, versionNumber, title, narrative, status, approvedBy?, rejectedBy?, rejectionReason?, modifiedBy, createdAt
       - MemoryItem: id, userId, type (Document | Photo | Video | Note | Audio), title, description?, fileUrl?, thumbnailUrl?, emotionalTags[], linkedJourneys[], sharingPermissions[], isLocked, unlockCondition?, isMilestone, createdAt, updatedAt
       - MessageThread: id, participants[], subject?, context (DomainContext), relatedResourceId?, relatedResourceType?, lastMessageAt, createdAt
       - Message: id, threadId, senderId, content, type ('user' | 'system'), attachments?, readBy[], sentAt
       - PrivacySettings: id, userId, discretionTier (High | Medium | Standard), invisibleItineraryDefault, dataRetention (days, 0=never), analyticsOptOut, thirdPartySharing, advisorVisibilityScope (string[]), globalEraseRequested, globalEraseExecutedAt?, createdAt, updatedAt
       - AccessPermission: id, grantedBy, grantedTo, resourceType, resourceId, permission (READ | WRITE | DELETE), expiresAt?, createdAt
       - RiskRecord: id, userId, institutionId, riskScore (0-100), riskCategory (Low | Medium | High | Critical), flags[], assessedBy, assessedAt, nextReviewDate, notes?
       - Contract: id, institutionId, tier, annualFee, perUserFee, startDate, endDate?, status (Active | Expired | Pending Renewal), signedBy, createdAt, updatedAt
       - RevenueRecord: id, institutionId, contractId, amount, currency (USD | EUR | GBP | CHF), type (Subscription | Usage | One-Time), period, paidAt?, createdAt
       - AuditEvent: id, event (string), userId, resourceId, resourceType, context (DomainContext), action ('CREATE' | 'READ' | 'UPDATE' | 'DELETE' | 'APPROVE'), metadata?, timestamp, previousState?, newState?
       - InviteCode: id, code, type ('b2c' | 'b2b' | 'admin'), createdBy, assignedRoles (UserRoles), institutionId?, maxUses, usedCount, expiresAt?, status ('active' | 'used' | 'expired' | 'revoked'), createdAt

       All entities must use string for dates (ISO 8601) and string UUIDs for IDs.

    4. Create `src/lib/types/validation.ts` with Zod schemas:
       - CreateUserSchema: email (email format), name (1-100), roles (object)
       - CreateJourneySchema: userId (uuid), title (1-200), narrative (10-5000), category (enum), context (b2c | b2b)
       - CreateMemorySchema: userId (uuid), type (enum), title (1-200), description? (max 2000)
       - CreateMessageSchema: threadId (uuid), senderId (uuid), content (1-5000)
       - CreateIntentProfileSchema: userId (uuid), emotionalDrivers (object with 0-100 numbers), riskTolerance (enum), values (string[]), lifeStage (enum)
       - CreateInstitutionSchema: name (1-200), type (enum), tier (enum)
       - Export inferred types: CreateJourneyInput, CreateMemoryInput, CreateMessageInput, etc.

    5. Create `src/lib/types/index.ts`:
       - Re-export everything from entities, roles, permissions, validation
  </action>
  <verify>
    Create a temporary test file that imports all types and attempts to create objects matching each interface. Run `pnpm tsc --noEmit` — must pass with zero errors. Delete the test file after verification.
  </verify>
  <done>
    All 15+ entity interfaces defined and compile. Enums for JourneyStatus, B2CRole, B2BRole, AdminRole, Permission defined. Zod schemas validate input data and infer matching TypeScript types. All types exported from barrel index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create service interfaces and mock localStorage implementations</name>
  <files>
    src/lib/services/interfaces/IJourneyService.ts
    src/lib/services/interfaces/IMemoryService.ts
    src/lib/services/interfaces/IMessageService.ts
    src/lib/services/interfaces/IIntentService.ts
    src/lib/services/interfaces/IUserService.ts
    src/lib/services/interfaces/IInstitutionService.ts
    src/lib/services/interfaces/IRiskService.ts
    src/lib/services/interfaces/IContractService.ts
    src/lib/services/interfaces/IAuditService.ts
    src/lib/services/interfaces/IPrivacyService.ts
    src/lib/services/interfaces/index.ts
    src/lib/services/mock/base.mock.ts
    src/lib/services/mock/journey.mock.ts
    src/lib/services/mock/memory.mock.ts
    src/lib/services/mock/message.mock.ts
    src/lib/services/mock/intent.mock.ts
    src/lib/services/mock/user.mock.ts
    src/lib/services/mock/institution.mock.ts
    src/lib/services/config.ts
    src/lib/services/index.ts
  </files>
  <action>
    1. Create `src/lib/services/interfaces/` with one file per service interface:

       **IJourneyService.ts:**
       - getJourneys(userId: string, context: DomainContext): Promise<Journey[]>
       - getJourneyById(id: string): Promise<Journey | null>
       - createJourney(data: CreateJourneyInput): Promise<Journey>
       - updateJourney(id: string, data: Partial<Journey>): Promise<Journey>
       - deleteJourney(id: string): Promise<boolean>
       - getJourneyVersions(journeyId: string): Promise<JourneyVersion[]>
       - createJourneyVersion(journeyId: string, data: Partial<JourneyVersion>): Promise<JourneyVersion>

       **IMemoryService.ts:**
       - getMemories(userId: string): Promise<MemoryItem[]>
       - getMemoryById(id: string): Promise<MemoryItem | null>
       - createMemory(data: CreateMemoryInput): Promise<MemoryItem>
       - updateMemory(id: string, data: Partial<MemoryItem>): Promise<MemoryItem>
       - deleteMemory(id: string): Promise<boolean>
       - lockMemory(id: string, unlockCondition: string): Promise<MemoryItem>
       - getSharedMemories(userId: string, viewerRole: string): Promise<MemoryItem[]>

       **IMessageService.ts:**
       - getThreads(userId: string): Promise<MessageThread[]>
       - getThreadById(id: string): Promise<MessageThread | null>
       - createThread(participants: string[], context: DomainContext, relatedResourceId?: string): Promise<MessageThread>
       - getMessages(threadId: string): Promise<Message[]>
       - sendMessage(data: CreateMessageInput): Promise<Message>
       - markAsRead(threadId: string, userId: string): Promise<void>

       **IIntentService.ts:**
       - getIntentProfile(userId: string): Promise<IntentProfile | null>
       - createIntentProfile(data: CreateIntentProfileInput): Promise<IntentProfile>
       - updateIntentProfile(userId: string, data: Partial<IntentProfile>): Promise<IntentProfile>
       - calculateAlignmentBaseline(profile: IntentProfile): number

       **IUserService.ts:**
       - getUsers(): Promise<User[]>
       - getUserById(id: string): Promise<User | null>
       - getUserByEmail(email: string): Promise<User | null>
       - createUser(data: CreateUserInput): Promise<User>
       - updateUser(id: string, data: Partial<User>): Promise<User>
       - deleteUser(id: string): Promise<boolean>
       - eraseUserData(id: string): Promise<void> (global erase)

       **IInstitutionService.ts:**
       - getInstitutions(): Promise<Institution[]>
       - getInstitutionById(id: string): Promise<Institution | null>
       - createInstitution(data: CreateInstitutionInput): Promise<Institution>
       - updateInstitution(id: string, data: Partial<Institution>): Promise<Institution>
       - suspendInstitution(id: string): Promise<Institution>

       **IRiskService.ts:**
       - getRiskRecords(institutionId: string): Promise<RiskRecord[]>
       - getRiskByUser(userId: string): Promise<RiskRecord | null>
       - createRiskRecord(data: Partial<RiskRecord>): Promise<RiskRecord>
       - updateRiskRecord(id: string, data: Partial<RiskRecord>): Promise<RiskRecord>

       **IContractService.ts:**
       - getContracts(institutionId: string): Promise<Contract[]>
       - getContractById(id: string): Promise<Contract | null>
       - createContract(data: Partial<Contract>): Promise<Contract>
       - getRevenueRecords(institutionId: string): Promise<RevenueRecord[]>

       **IAuditService.ts:**
       - log(event: Omit<AuditEvent, 'id' | 'timestamp'>): void
       - getAll(): AuditEvent[]
       - getByResource(resourceType: string, resourceId: string): AuditEvent[]
       - getByUser(userId: string): AuditEvent[]
       - getByContext(context: DomainContext): AuditEvent[]
       - anonymizeUser(userId: string): void

       **IPrivacyService.ts:**
       - getSettings(userId: string): Promise<PrivacySettings | null>
       - updateSettings(userId: string, data: Partial<PrivacySettings>): Promise<PrivacySettings>
       - executeGlobalErase(userId: string): Promise<void>

       Create `src/lib/services/interfaces/index.ts` barrel export.

    2. Create `src/lib/services/mock/base.mock.ts`:
       - Abstract BaseMockService class with:
         - protected delay(ms?: number): Promise<void> — default 300ms, random jitter 0-200ms
         - protected getFromStorage<T>(key: string): T[]
         - protected setInStorage<T>(key: string, data: T[]): void
         - protected generateId(): string — uses crypto.randomUUID()
         - protected now(): string — returns new Date().toISOString()
       - Storage key prefix: 'elan:'

    3. Create mock implementations for the 6 most critical services:

       **mock/journey.mock.ts** — implements IJourneyService using BaseMockService
       **mock/memory.mock.ts** — implements IMemoryService using BaseMockService
       **mock/message.mock.ts** — implements IMessageService using BaseMockService
       **mock/intent.mock.ts** — implements IIntentService using BaseMockService
       **mock/user.mock.ts** — implements IUserService using BaseMockService
       **mock/institution.mock.ts** — implements IInstitutionService using BaseMockService

       Each mock service must:
       - Extend BaseMockService
       - Implement all interface methods
       - Use localStorage for persistence
       - Add realistic delays (300-500ms)
       - Return production-shaped data (matching entity interfaces exactly)
       - Handle edge cases (not found returns null, delete returns boolean)

       DO NOT implement mock services for Risk, Contract, Audit, Privacy yet — those are handled by Plan 01-05 (RBAC + Audit) or can use interface-only stubs. For now, create the interfaces only.

    4. Create `src/lib/services/config.ts`:
       - Read NEXT_PUBLIC_USE_MOCK_SERVICES environment variable
       - Export services object that selects mock implementations when USE_MOCK is true
       - Type the services object with all interface types
       - Add TODO comment for future API implementations

    5. Create `src/lib/services/index.ts`:
       - Re-export services from config
       - Re-export all interfaces
  </action>
  <verify>
    Run `pnpm tsc --noEmit` — all service files compile without errors.
    Verify that each mock service class implements its interface (TypeScript will error if methods are missing).
    Verify services object in config.ts has all 6 mock service properties typed correctly.
  </verify>
  <done>
    10 service interfaces defined covering all entity operations. 6 mock implementations (journey, memory, message, intent, user, institution) working with localStorage persistence and realistic delays. Service config selects mock/real based on environment variable. All files compile with zero TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. All 15+ entity types importable from `@/lib/types`
3. All service interfaces importable from `@/lib/services/interfaces`
4. `services.journey.getJourneys('test', 'b2c')` returns a Promise<Journey[]>
5. Mock services use localStorage (inspect in browser DevTools > Application > Local Storage)
6. Zod schemas reject invalid data (test with invalid email, missing required fields)
</verification>

<success_criteria>
- 15+ entity type definitions with correct relationships and enums
- Zod validation schemas for all create operations
- 10 service interface contracts covering CRUD for all entities
- 6 mock service implementations with localStorage persistence
- Service registry with environment-based selection
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-design-system/01-04-SUMMARY.md`
</output>
